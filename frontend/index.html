<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mushroom Farm CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: #1a7346;
  --color-primary-light: #22a35f;
  --color-primary-dark: #156238;
  --color-primary-hover: #156238;
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;

  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
}

.app-container {
  display: flex;
  min-height: 100vh;
}

/* Top Navigation */
.top-nav {
  position: fixed;
  top: 0;
  left: 260px;
  right: 0;
  height: 64px;
  background-color: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--space-32);
  z-index: 90;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
}

.top-nav-left {
  display: flex;
  align-items: center;
  gap: var(--space-16);
  flex: 1;
}

.top-nav-search {
  max-width: 400px;
  width: 100%;
}

.top-nav-right {
  display: flex;
  align-items: center;
  gap: var(--space-16);
}

.nav-icon-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-full);
  border: none;
  background-color: transparent;
  color: var(--color-text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all var(--duration-fast) var(--ease-standard);
}

.nav-icon-btn:hover {
  background-color: var(--color-secondary);
  color: var(--color-text);
}

.user-profile {
  display: flex;
  align-items: center;
  gap: var(--space-12);
  padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: background-color var(--duration-fast) var(--ease-standard);
}

.user-profile:hover {
  background-color: var(--color-secondary);
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-full);
  background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-sm);
}

.user-info {
  display: flex;
  flex-direction: column;
}

.user-name {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  line-height: 1.2;
}

.user-role {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  line-height: 1.2;
}

@media (max-width: 768px) {
  .top-nav {
    left: 0;
  }
  
  .top-nav-search {
    display: none;
  }
  
  .user-info {
    display: none;
  }
}

/* Sidebar */
.sidebar {
  width: 260px;
  background-color: var(--color-surface);
  border-right: 1px solid var(--color-border);
  padding: var(--space-24);
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  transition: transform var(--duration-normal) var(--ease-standard);
  z-index: 100;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
}

.sidebar-header {
  margin-bottom: var(--space-32);
}

.sidebar-logo {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: #1a7346;
  display: flex;
  align-items: center;
  gap: var(--space-8);
}

.sidebar-logo-icon {
  font-size: var(--font-size-3xl);
}

.nav-menu {
  list-style: none;
}

.nav-item {
  margin-bottom: var(--space-4);
}

.nav-link {
  display: flex;
  align-items: center;
  gap: var(--space-12);
  padding: var(--space-12) var(--space-16);
  color: var(--color-text-secondary);
  text-decoration: none;
  border-radius: var(--radius-base);
  transition: all var(--duration-fast) var(--ease-standard);
  cursor: pointer;
  font-weight: var(--font-weight-medium);
}

.nav-link:hover {
  background-color: var(--color-secondary);
  color: var(--color-text);
}

.nav-link.active {
  background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(26, 115, 70, 0.3);
}

.nav-icon {
  font-size: var(--font-size-xl);
  width: 24px;
  text-align: center;
}

/* Main Content */
.main-content {
  flex: 1;
  margin-left: 260px;
  margin-top: 64px;
  padding: var(--space-32);
  width: calc(100% - 260px);
  background-color: var(--color-background);
  min-height: calc(100vh - 64px);
}

.page-header {
  margin-bottom: var(--space-32);
  animation: fadeIn 0.3s ease-out;
}

.page-title {
  font-size: 32px;
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--space-8);
  color: var(--color-text);
  letter-spacing: -0.02em;
}

.page-subtitle {
  color: var(--color-text-secondary);
  font-size: var(--font-size-base);
}

.section {
  display: none;
}

.section.active {
  display: block;
}

/* Cards */
.card {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  padding: var(--space-24);
  margin-bottom: var(--space-24);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
  transition: box-shadow var(--duration-normal) var(--ease-standard);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-20);
  padding-bottom: var(--space-16);
  border-bottom: 1px solid var(--color-card-border-inner);
}

.card-title {
  font-size: 20px;
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  letter-spacing: -0.01em;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: var(--space-20);
  margin-bottom: var(--space-24);
}

.stats-grid .stat-card {
  animation: fadeIn 0.4s ease-out;
}

.stats-grid .stat-card:nth-child(1) { animation-delay: 0.05s; }
.stats-grid .stat-card:nth-child(2) { animation-delay: 0.1s; }
.stats-grid .stat-card:nth-child(3) { animation-delay: 0.15s; }
.stats-grid .stat-card:nth-child(4) { animation-delay: 0.2s; }

.stat-card {
  background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-background) 100%);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  transition: all var(--duration-normal) var(--ease-standard);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #1a7346, #22a35f, #1a7346);
  background-size: 200% 100%;
  animation: gradientShift 3s ease infinite;
}

.stat-card:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 12px 32px rgba(26, 115, 70, 0.2);
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-12);
}

.stat-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
}

.stat-icon {
  font-size: 36px;
  opacity: 0.9;
  line-height: 1;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  transition: transform var(--duration-normal) var(--ease-standard);
}

.stat-card:hover .stat-icon {
  transform: scale(1.1) rotate(5deg);
}

.stat-value {
  font-size: 36px;
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--space-4);
  color: var(--color-text);
  line-height: 1.2;
  background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: counterPulse 0.6s ease-out;
}

@keyframes counterPulse {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); opacity: 1; }
}

.stat-change {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.stat-change.positive {
  color: var(--color-success);
}

.stat-change.negative {
  color: var(--color-error);
}

/* Forms */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--space-16);
  margin-bottom: var(--space-20);
}

.form-group {
  margin-bottom: var(--space-16);
}

.form-label {
  display: block;
  margin-bottom: var(--space-8);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
  color: var(--color-text);
}

.form-control {
  width: 100%;
  padding: var(--space-10) var(--space-12);
  font-size: var(--font-size-base);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  background-color: var(--color-surface);
  color: var(--color-text);
  transition: all var(--duration-fast) var(--ease-standard);
}

.form-control:focus {
  outline: none;
  border-color: #1a7346;
  box-shadow: 0 0 0 3px rgba(26, 115, 70, 0.1);
}

textarea.form-control {
  min-height: 80px;
  resize: vertical;
  font-family: var(--font-family-base);
}

select.form-control {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right var(--space-12) center;
  background-size: 16px;
  padding-right: var(--space-32);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-8);
  padding: var(--space-10) var(--space-20);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  border: none;
  border-radius: var(--radius-base);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  text-decoration: none;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::before {
  width: 300px;
  height: 300px;
}

.btn-primary {
  background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(26, 115, 70, 0.25);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #156238 0%, #1a7346 100%);
  box-shadow: 0 4px 12px rgba(26, 115, 70, 0.35);
  transform: translateY(-1px);
}

.btn-secondary {
  background-color: var(--color-secondary);
  color: var(--color-text);
  border: 1px solid var(--color-border);
}

.btn-secondary:hover {
  background-color: var(--color-secondary-hover);
  border-color: var(--color-text-secondary);
}

.btn-small {
  padding: var(--space-6) var(--space-12);
  font-size: var(--font-size-sm);
}

.btn-danger {
  background-color: var(--color-error);
  color: var(--color-white);
  box-shadow: 0 2px 8px rgba(192, 21, 47, 0.25);
}

.btn-danger:hover {
  background-color: #a01530;
  box-shadow: 0 4px 12px rgba(192, 21, 47, 0.35);
  transform: translateY(-1px);
}

.btn-success {
  background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(26, 115, 70, 0.25);
}

.btn-success:hover {
  background: linear-gradient(135deg, #156238 0%, #1a7346 100%);
  box-shadow: 0 4px 12px rgba(26, 115, 70, 0.35);
  transform: translateY(-1px);
}

/* Tables */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius-base);
  border: 1px solid var(--color-border);
  animation: fadeIn 0.4s ease-out;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background-color: var(--color-bg-3);
}

th {
  padding: var(--space-12) var(--space-16);
  text-align: left;
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-sm);
  color: var(--color-text);
  border-bottom: 2px solid var(--color-border);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

td {
  padding: var(--space-12) var(--space-16);
  border-bottom: 1px solid var(--color-card-border-inner);
  font-size: var(--font-size-sm);
}

tbody tr:hover {
  background-color: var(--color-bg-3);
  cursor: pointer;
}

/* Status Badges */
.badge {
  display: inline-flex;
  align-items: center;
  padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-semibold);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.badge-success {
  background-color: rgba(26, 115, 70, 0.15);
  color: #1a7346;
  border: 1px solid rgba(26, 115, 70, 0.25);
}

.badge-warning {
  background-color: rgba(243, 156, 18, 0.15);
  color: #d97706;
  border: 1px solid rgba(243, 156, 18, 0.25);
}

.badge-danger {
  background-color: rgba(var(--color-error-rgb), 0.15);
  color: var(--color-error);
  border: 1px solid rgba(var(--color-error-rgb), 0.25);
}

.badge-info {
  background-color: rgba(52, 152, 219, 0.15);
  color: #3498db;
  border: 1px solid rgba(52, 152, 219, 0.25);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: var(--space-8);
}

.btn-icon {
  padding: var(--space-6);
  border-radius: var(--radius-sm);
  border: 1px solid var(--color-border);
  background-color: transparent;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  font-size: var(--font-size-base);
}

.btn-icon:hover {
  background-color: var(--color-secondary);
  transform: scale(1.1);
}

.btn-icon:active {
  transform: scale(0.95);
}

/* Quick Actions */
.quick-actions {
  display: flex;
  gap: var(--space-12);
  margin-bottom: var(--space-24);
  flex-wrap: wrap;
  animation: fadeIn 0.5s ease-out;
}

/* Chart Styles */
.chart-container {
  margin: var(--space-20) 0;
}

.bar-chart {
  display: flex;
  align-items: flex-end;
  height: 200px;
  gap: var(--space-12);
  padding: var(--space-16) 0;
}

.bar-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-8);
}

.bar {
  width: 100%;
  background: linear-gradient(180deg, #22a35f 0%, #1a7346 100%);
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  transition: all var(--duration-normal) var(--ease-standard);
  position: relative;
  min-height: 20px;
}

.bar:hover {
  background: linear-gradient(180deg, #2bc46f 0%, #22a35f 100%);
  transform: scaleY(1.05);
  transform-origin: bottom;
}

.bar-label {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  text-align: center;
}

.bar-value {
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  color: var(--color-text);
}

/* Filter Bar */
.filter-bar {
  display: flex;
  gap: var(--space-12);
  margin-bottom: var(--space-20);
  flex-wrap: wrap;
  align-items: center;
}

.search-box {
  flex: 1;
  min-width: 200px;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: var(--space-32);
  color: var(--color-text-secondary);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: var(--space-16);
  opacity: 0.4;
  line-height: 1;
}

/* Product Grid */
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--space-20);
}

.product-card {
  background-color: var(--color-surface);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
  transition: all var(--duration-normal) var(--ease-standard);
}

.product-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.06);
  transform: translateY(-2px);
}

.product-icon {
  font-size: 56px;
  margin-bottom: var(--space-16);
  text-align: center;
  line-height: 1;
}

.product-name {
  font-size: 18px;
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-8);
  color: var(--color-text);
  line-height: 1.3;
}

.product-category {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-12);
}

.product-prices {
  margin: var(--space-12) 0;
}

.price-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: var(--space-6);
  font-size: var(--font-size-sm);
}

.product-stock {
  margin: var(--space-12) 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.product-actions {
  display: flex;
  gap: var(--space-8);
  margin-top: var(--space-16);
}

/* Mobile Menu Toggle */
.mobile-menu-toggle {
  display: none;
  position: fixed;
  top: var(--space-16);
  left: var(--space-16);
  z-index: 101;
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
  border: none;
  border-radius: var(--radius-base);
  padding: var(--space-10);
  font-size: var(--font-size-xl);
  cursor: pointer;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 200;
  justify-content: center;
  align-items: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-20);
}

.modal-title {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
}

.modal-close {
  background: none;
  border: none;
  font-size: var(--font-size-2xl);
  cursor: pointer;
  color: var(--color-text-secondary);
}

/* Alert Messages */
.alert {
  padding: var(--space-12) var(--space-16);
  border-radius: var(--radius-base);
  margin-bottom: var(--space-16);
  display: flex;
  align-items: center;
  gap: var(--space-12);
}

.alert-success {
  background-color: rgba(var(--color-success-rgb), 0.15);
  color: var(--color-success);
  border: 1px solid rgba(var(--color-success-rgb), 0.25);
}

.alert-error {
  background-color: rgba(var(--color-error-rgb), 0.15);
  color: var(--color-error);
  border: 1px solid rgba(var(--color-error-rgb), 0.25);
}

/* Tab Buttons */
.btn-secondary {
    transition: border-bottom 0.2s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .card > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
  .sidebar {
    transform: translateX(-100%);
  }

  .sidebar.active {
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0;
    margin-top: 64px;
    width: 100%;
    padding: var(--space-20);
  }

  .mobile-menu-toggle {
    display: block;
  }

  .stats-grid {
    grid-template-columns: 1fr;
    gap: var(--space-16);
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .filter-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .quick-actions {
    flex-direction: column;
  }

  .product-grid {
    grid-template-columns: 1fr;
  }

  .page-title {
    font-size: 24px;
  }

  .card {
    padding: var(--space-16);
  }
  
  /* Wholesale line items responsive */
  .wholesale-line-item {
    grid-template-columns: 1fr !important;
  }
  
  .wholesale-line-item button {
    width: 100%;
  }
  
  /* Tables scroll horizontally on mobile */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table {
    min-width: 600px;
  }
  
  /* Charts responsive */
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  /* Profit banner responsive */
  .profit-banner-breakdown {
    flex-direction: column;
    gap: var(--space-12) !important;
  }
  
  /* Action buttons stack on mobile */
  .action-buttons {
    flex-direction: column;
    gap: var(--space-4);
  }
  
  .action-buttons .btn,
  .action-buttons .btn-icon {
    width: 100%;
  }
}

/* Tablet adjustments */
@media (min-width: 769px) and (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .product-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .wholesale-line-item {
    grid-template-columns: 2fr 1fr 1fr 1fr auto !important;
  }
}

/* Utility Classes */
.text-center { text-align: center; }
.text-right { text-align: right; }
.mt-8 { margin-top: var(--space-8); }
.mt-16 { margin-top: var(--space-16); }
.mb-8 { margin-bottom: var(--space-8); }
.mb-16 { margin-bottom: var(--space-16); }
.flex { display: flex; }
.justify-between { justify-content: space-between; }
.items-center { align-items: center; }
.gap-8 { gap: var(--space-8); }
.gap-12 { gap: var(--space-12); }

/* Wholesale line item styles */
.wholesale-line-item {
    transition: all var(--duration-fast) var(--ease-standard);
}

.wholesale-line-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Loading Spinner */
.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Fade in animation */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100%);
  }
}

/* Profit Banner Styles */
.profit-banner {
  background: linear-gradient(135deg, #1a7346 0%, #22a35f 50%, #2bc46f 100%);
  border-radius: var(--radius-lg);
  padding: var(--space-32);
  margin-bottom: var(--space-32);
  color: white;
  box-shadow: 0 8px 32px rgba(26, 115, 70, 0.3);
  position: relative;
  overflow: hidden;
  animation: fadeIn 0.6s ease-out;
}

.profit-banner::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -10%;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
  border-radius: 50%;
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 0.5; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.profit-banner-content {
  position: relative;
  z-index: 1;
  text-align: center;
}

.profit-banner-title {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-12);
  opacity: 0.95;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.profit-banner-amount {
  font-size: 56px;
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--space-8);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  animation: counterPulse 0.8s ease-out;
}

.profit-banner-subtitle {
  font-size: var(--font-size-base);
  margin-bottom: var(--space-16);
  opacity: 0.9;
}

.profit-banner-breakdown {
  display: flex;
  justify-content: center;
  gap: var(--space-32);
  margin-top: var(--space-20);
  padding-top: var(--space-20);
  border-top: 1px solid rgba(255, 255, 255, 0.2);
  flex-wrap: wrap;
}

.breakdown-item {
  text-align: center;
}

.breakdown-label {
  font-size: var(--font-size-sm);
  opacity: 0.8;
  margin-bottom: var(--space-4);
}

.breakdown-value {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
}

/* Charts Grid */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-24);
  margin-bottom: var(--space-24);
}

.chart-card {
  animation: fadeIn 0.5s ease-out;
}

.expense-legend {
  padding: var(--space-16);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-12);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: var(--space-8);
  font-size: var(--font-size-sm);
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: var(--radius-sm);
  flex-shrink: 0;
}

/* Recent Transactions List */
.recent-transactions-list {
  padding: var(--space-16);
}

.transaction-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-16);
  border-bottom: 1px solid var(--color-card-border-inner);
  transition: background-color var(--duration-fast) var(--ease-standard);
}

.transaction-item:hover {
  background-color: var(--color-bg-3);
}

.transaction-item:last-child {
  border-bottom: none;
}

.transaction-left {
  display: flex;
  align-items: center;
  gap: var(--space-12);
}

.transaction-avatar {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-full);
  background: linear-gradient(135deg, #1a7346, #22a35f);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: var(--font-weight-bold);
  font-size: var(--font-size-sm);
}

.transaction-info h4 {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-4);
}

.transaction-info p {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin: 0;
}

.transaction-right {
  text-align: right;
}

.transaction-amount {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-bold);
  color: #1a7346;
  margin-bottom: var(--space-4);
}

.transaction-time {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

/* Welcome Section */
.welcome-section {
  animation: fadeIn 0.4s ease-out;
}

@media (max-width: 768px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .expense-legend {
    grid-template-columns: 1fr;
  }
  
  .profit-banner-amount {
    font-size: 40px;
  }
  
  .profit-banner-breakdown {
    gap: var(--space-16);
  }
}

.fade-in {
  animation: fadeIn 0.3s ease-out;
}

/* Highlight animation */
@keyframes highlight {
  0%, 100% {
    background-color: transparent;
  }
  50% {
    background-color: rgba(26, 115, 70, 0.1);
  }
}

.highlight-row {
  animation: highlight 1s ease-out;
}
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>

    <div class="app-container">
        <!-- Top Navigation Bar -->
        <nav class="top-nav">
            <div class="top-nav-left">
                <h2 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--color-text);">Mushroom Farm CRM</h2>
            </div>
            <div class="top-nav-right">
                <button class="nav-icon-btn" id="notificationBtn" title="Notifications" onclick="toggleNotifications()" style="position: relative;">
                    üîî
                    <span id="notificationBadge" style="position: absolute; top: 4px; right: 4px; background: var(--color-error); color: white; border-radius: var(--radius-full); width: 18px; height: 18px; font-size: 10px; display: none; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <div class="user-profile" onclick="toggleUserMenu()" style="cursor: pointer;">
                    <div class="user-avatar">FM</div>
                    <div class="user-info">
                        <span class="user-name">Farm Manager</span>
                        <span class="user-role">Administrator</span>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Notification Panel -->
        <div id="notificationPanel" style="position: fixed; top: 70px; right: 20px; width: 400px; max-height: 500px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 1000; display: none; overflow: hidden;">
            <div style="padding: var(--space-16); border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0;">Notifications</h3>
                <button onclick="clearAllNotifications()" class="btn btn-small btn-secondary">Clear All</button>
            </div>
            <div id="notificationList" style="max-height: 400px; overflow-y: auto; padding: var(--space-12);">
                <!-- Notifications will be populated here -->
            </div>
        </div>
        
        <!-- Toast Notification -->
        <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 1001; display: flex; flex-direction: column; gap: var(--space-12);"></div>
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="sidebar-logo-icon">üçÑ</span>
                    <span>MushroomCRM</span>
                </div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link active" data-section="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="sales">
                            <span class="nav-icon">üí∞</span>
                            <span>Sales</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="inventory">
                            <span class="nav-icon">üì¶</span>
                            <span>Inventory</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="products">
                            <span class="nav-icon">üçÑ</span>
                            <span>Products</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="wholesale">
                            <span class="nav-icon">üè™</span>
                            <span>Wholesale</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="stockprep">
                            <span class="nav-icon">üìã</span>
                            <span>Stock Prep</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="subscriptions">
                            <span class="nav-icon">üîÑ</span>
                            <span>Subscriptions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="analytics">
                            <span class="nav-icon">üìà</span>
                            <span>Sales Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="expenses">
                            <span class="nav-icon">üí≥</span>
                            <span>Expenses</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="profitloss">
                            <span class="nav-icon">üìã</span>
                            <span>Profit &amp; Loss</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="returns">
                            <span class="nav-icon">‚Ü©Ô∏è</span>
                            <span>Sales Returns</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Section -->
            <section class="section active" id="dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle" id="currentDateTime">Overview of your mushroom farm business</p>
                </div>

                <div class="welcome-section" style="margin-bottom: var(--space-32);">
                    <h2 style="font-size: 28px; font-weight: var(--font-weight-bold); margin-bottom: var(--space-8);">Welcome back, Farm Manager üëã</h2>
                    <p id="currentDateTimeWelcome" style="color: var(--color-text-secondary); font-size: var(--font-size-lg);"></p>
                </div>

                <div class="stats-grid" id="dashboardStats">
                    <!-- Stats will be populated by JavaScript -->
                </div>

                <div class="profit-banner" id="profitBanner">
                    <div class="profit-banner-content">
                        <div class="profit-banner-title">Overall Current Month Profit</div>
                        <div class="profit-banner-amount" id="overallProfitValue">‚Çπ0</div>
                        <div class="profit-banner-subtitle" id="overallProfitSubtitle"></div>
                        <div class="profit-banner-breakdown" id="profitBreakdown"></div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h2 class="card-title">üìä Current Month Sales Trend (Day-wise)</h2>
                            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: 0;">Number of boxes sold per day</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="salesLineChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card">
                        <div class="card-header">
                            <h2 class="card-title">üí∞ Expense Breakdown (This Month)</h2>
                            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: 0;" id="expenseTotal">‚Çπ0 Total</p>
                        </div>
                        <div class="chart-container" style="display: flex; justify-content: center; padding: var(--space-24);">
                            <canvas id="expensePieChart" width="280" height="280"></canvas>
                        </div>
                        <div id="expenseLegend" class="expense-legend">
                            <!-- Legend will be populated -->
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="showAddSaleModal()">+ Add Sale</button>
                    <button class="btn btn-secondary" onclick="showAddProductModal()">+ Add Product</button>
                    <button class="btn btn-secondary" onclick="showAddExpenseModal()">+ Add Expense</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üîî Recent Transactions</h2>
                    </div>
                    <div id="recentTransactions" class="recent-transactions-list">
                        <!-- Recent transactions will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Top Selling Products</h2>
                    </div>
                    <div id="topProducts">
                        <!-- Top products will be populated -->
                    </div>
                </div>
            </section>

            <!-- Sales Section (Enhanced with Tabs) -->
            <section class="section" id="sales">
                <div class="page-header">
                    <h1 class="page-title">Sales Management</h1>
                    <p class="page-subtitle">Track and manage all your sales transactions</p>
                </div>

                <div class="card">
                    <div class="card-header" style="border-bottom: none;">
                        <div style="display: flex; gap: var(--space-8); border-bottom: 2px solid var(--color-border);">
                            <button type="button" class="btn btn-secondary" id="retailTabBtn" onclick="switchSalesTab('retail')" style="border-radius: 0; border-bottom: 3px solid var(--color-primary);">
                                Retail Sale
                            </button>
                            <button type="button" class="btn btn-secondary" id="wholesaleTabBtn" onclick="switchSalesTab('wholesale')" style="border-radius: 0;">
                                Wholesale Sale
                            </button>
                        </div>
                    </div>
                    
                    <!-- Retail Sale Form -->
                    <form id="retailSalesForm" style="display: block;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="retailSaleDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="retailCustomerName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Customer Phone</label>
                                <input type="tel" class="form-control" id="retailCustomerPhone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Product</label>
                                <select class="form-control" id="retailProduct" required onchange="updateRetailPrice()">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <div style="display: flex; align-items: center; gap: var(--space-12); margin-top: var(--space-8);">
                                    <button type="button" class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 24px; padding: 0;" onclick="decreaseRetailQty()">‚àí</button>
                                    <input type="number" class="form-control" id="retailQuantity" value="1" min="1" step="1" required style="width: 100px; text-align: center; font-size: 24px; font-weight: bold;">
                                    <button type="button" class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 24px; padding: 0;" onclick="increaseRetailQty()">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit Price (‚Çπ)</label>
                                <input type="number" class="form-control" id="retailUnitPrice" step="0.01" required oninput="calculateRetailTotal()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total Amount (‚Çπ)</label>
                                <input type="number" class="form-control" id="retailTotalAmount" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-control" id="retailPaymentMethod" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Credit">Credit</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="retailNotes"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Retail Sale</button>
                    </form>
                    
                    <!-- Wholesale Sale Form -->
                    <form id="wholesaleSalesForm" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="wholesaleSaleDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Shop Name</label>
                                <input type="text" class="form-control" id="wholesaleVendorName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" class="form-control" id="wholesaleVendorContact" required>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label class="form-label">Shop Address</label>
                                <textarea class="form-control" id="wholesaleVendorAddress" rows="2" required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin: var(--space-16) 0;">
                            <label class="form-label">Supply Days (Select delivery days)</label>
                            <div style="display: flex; gap: var(--space-12); flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Monday"> Monday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Tuesday"> Tuesday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Wednesday"> Wednesday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Thursday"> Thursday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Friday"> Friday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Saturday"> Saturday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="wholesaleSupplyDay" value="Sunday"> Sunday
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin: var(--space-20) 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-12);">
                                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">Products</h3>
                                <button type="button" class="btn btn-secondary btn-small" onclick="addWholesaleLineItem()">+ Add Product</button>
                            </div>
                            <div id="wholesaleLineItems">
                                <!-- Line items will be added here -->
                            </div>
                        </div>
                        
                        <div style="background: var(--color-bg-3); padding: var(--space-16); border-radius: var(--radius-base); margin-bottom: var(--space-16);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-8);">
                                <span>Subtotal:</span>
                                <strong id="wholesaleSubtotal">‚Çπ0.00</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-8);">
                                <span>Discount (%):</span>
                                <input type="number" id="wholesaleDiscount" value="0" min="0" max="100" step="0.1" style="width: 100px; text-align: right;" class="form-control" oninput="calculateWholesaleTotal()">
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: var(--space-8); border-top: 2px solid var(--color-border);">
                                <strong style="font-size: var(--font-size-lg);">Total Amount:</strong>
                                <strong id="wholesaleTotalAmount" style="font-size: var(--font-size-xl); color: var(--color-primary);">‚Çπ0.00</strong>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select class="form-control" id="wholesalePaymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Credit">Credit</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="wholesaleNotes"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Add Wholesale Sale</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Sales History</h2>
                    </div>
                    <div class="filter-bar">
                        <div class="search-box">
                            <input type="text" class="form-control" id="salesSearch" placeholder="Search by customer or product...">
                        </div>
                        <select class="form-control" id="salesTypeFilter" style="width: 200px;">
                            <option value="">All Types</option>
                            <option value="Retail">Retail</option>
                            <option value="Wholesale">Wholesale</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer/Shop</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Sales will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Section (Enhanced with Warehouses) -->
            <section class="section" id="inventory">
                <div class="page-header">
                    <h1 class="page-title">Inventory Management</h1>
                    <p class="page-subtitle">Monitor and manage your stock levels</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Warehouse Management</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddWarehouseModal()">+ Add Warehouse</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Warehouse Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="warehousesTableBody">
                                <!-- Warehouses will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Warehouse-wise Stock Overview</h2>
                        <select class="form-control" id="warehouseFilter" style="width: 250px;" onchange="renderInventoryTable()">
                            <option value="">All Warehouses</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Warehouse</th>
                                    <th>Stock Quantity</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Inventory will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Inventory Management</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddStockModal()">+ Add Stock</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Inventory History</h2>
                    </div>
                    <div id="inventoryHistorySummary" style="padding: var(--space-20); background: var(--color-bg-3); margin: var(--space-16); border-radius: var(--radius-base); border: 1px solid var(--color-border);">
                        <!-- Summary box will be populated -->
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Warehouse</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Transaction</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryHistoryBody">
                                <!-- Inventory history will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Products Section -->
            <section class="section" id="products">
                <div class="page-header">
                    <h1 class="page-title">Products Management</h1>
                    <p class="page-subtitle">Manage your product catalog</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Products Management</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddProductModal()">+ Add Product</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Product Catalog</h2>
                    </div>
                    <div class="product-grid" id="productsGrid">
                        <!-- Products will be populated -->
                    </div>
                </div>
            </section>

            <!-- Wholesale Section -->
            <section class="section" id="wholesale">
                <div class="page-header">
                    <h1 class="page-title">Wholesale Management</h1>
                    <p class="page-subtitle">Manage wholesale customers and orders</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Wholesale Customer Management</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddWholesaleCustomerModal()">+ Add Customer</button>
                    </div>
                </div>

                <div class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="card-title">Add Wholesale Customer</h2>
                    </div>
                    <form id="wholesaleCustomerForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="wholesaleCustomerName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Business Name</label>
                                <input type="text" class="form-control" id="wholesaleBusinessName">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" class="form-control" id="wholesalePhone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="wholesaleEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Credit Limit (‚Çπ)</label>
                                <input type="number" class="form-control" id="wholesaleCreditLimit" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="wholesaleAddress"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Customer</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Wholesale Customers</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Business</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Credit Limit</th>
                                    <th>Outstanding</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="wholesaleCustomersBody">
                                <!-- Wholesale customers will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Wholesale Transactions</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                </tr>
                            </thead>
                            <tbody id="wholesaleTransactionsBody">
                                <!-- Wholesale transactions will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Sales Analytics Section -->
            <section class="section" id="analytics">
                <div class="page-header">
                    <h1 class="page-title">Sales Analytics</h1>
                    <p class="page-subtitle">Analyze your sales performance</p>
                </div>

                <div class="filter-bar">
                    <select class="form-control" id="analyticsPeriod" style="width: 200px;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <div class="card">
                    <div style="padding: var(--space-16); background: var(--color-bg-3); border-radius: var(--radius-base);">
                        <div id="revenueSummaryLine" style="font-size: var(--font-size-base); color: var(--color-text); text-align: center;">
                            <!-- Single line revenue summary will be populated -->
                        </div>
                    </div>
                </div>

                <div class="stats-grid" id="analyticsStats">
                    <!-- Analytics stats will be populated -->
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Sales by Product</h2>
                    </div>
                    <div class="chart-container">
                        <div class="bar-chart" id="salesByProductChart">
                            <!-- Chart will be populated -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Returns Overview</h2>
                    </div>
                    <div class="stats-grid" id="returnsAnalyticsStats">
                        <!-- Returns stats will be populated -->
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Returns Count</th>
                                    <th>Quantity Returned</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="topReturnedProductsBody">
                                <!-- Top returned products will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Top Customers</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Total Purchases</th>
                                    <th>Orders</th>
                                </tr>
                            </thead>
                            <tbody id="topCustomersBody">
                                <!-- Top customers will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Expenses Section -->
            <section class="section" id="expenses">
                <div class="page-header">
                    <h1 class="page-title">Expense Tracking</h1>
                    <p class="page-subtitle">Track all your business expenses</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Expense Management</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddExpenseModal()">+ Add Expense</button>
                    </div>
                </div>

                <div class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="card-title">Add New Expense</h2>
                    </div>
                    <form id="expensesForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="expenseDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-control" id="expenseCategory" required>
                                    <option value="Raw Materials">Raw Materials</option>
                                    <option value="Labor">Labor</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Transportation">Transportation</option>
                                    <option value="Packaging">Packaging</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount (‚Çπ)</label>
                                <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-control" id="expensePaymentMethod" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendor/Supplier</label>
                                <input type="text" class="form-control" id="expenseVendor">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="expenseDescription" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Expenses Summary</h2>
                    </div>
                    <div class="stats-grid" id="expensesStats">
                        <!-- Expenses stats will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Expense History</h2>
                    </div>
                    <div class="filter-bar">
                        <select class="form-control" id="expenseCategoryFilter" style="width: 200px;">
                            <option value="">All Categories</option>
                            <option value="Raw Materials">Raw Materials</option>
                            <option value="Labor">Labor</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Packaging">Packaging</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Vendor</th>
                                    <th>Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <!-- Expenses will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Profit & Loss Section -->
            <section class="section" id="profitloss">
                <div class="page-header">
                    <h1 class="page-title">Profit &amp; Loss Statement</h1>
                    <p class="page-subtitle">Financial overview of your business</p>
                </div>

                <div class="filter-bar">
                    <select class="form-control" id="plPeriod" style="width: 200px;">
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportPL()">Export Report</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Revenue</h2>
                    </div>
                    <div id="plRevenue">
                        <!-- Revenue details will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Cost of Goods Sold (COGS)</h2>
                    </div>
                    <div id="plCOGS">
                        <!-- COGS details will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Operating Expenses</h2>
                    </div>
                    <div id="plExpenses">
                        <!-- Expenses details will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Returns &amp; Adjustments</h2>
                    </div>
                    <div id="plReturns">
                        <!-- Returns will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Net Profit</h2>
                    </div>
                    <div id="plNetProfit">
                        <!-- Net profit will be populated -->
                    </div>
                </div>
            </section>

            <!-- Stock Prep Section -->
            <section class="section" id="stockprep">
                <div class="page-header">
                    <h1 class="page-title">Stock Preparation</h1>
                    <p class="page-subtitle">Manage today's and tomorrow's orders</p>
                </div>

                <div class="card">
                    <div class="card-header" style="border-bottom: none;">
                        <div style="display: flex; gap: var(--space-8); border-bottom: 2px solid var(--color-border);">
                            <button class="btn btn-secondary" id="todayTabBtn" onclick="switchStockPrepTab('today')" style="border-radius: 0; border-bottom: 3px solid var(--color-primary);">
                                Today's Orders
                            </button>
                            <button class="btn btn-secondary" id="tomorrowTabBtn" onclick="switchStockPrepTab('tomorrow')" style="border-radius: 0;">
                                Tomorrow's Orders
                            </button>
                        </div>
                    </div>
                    <div id="stockPrepContent">
                        <!-- Content will be populated -->
                    </div>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section class="section" id="subscriptions">
                <div class="page-header">
                    <h1 class="page-title">Subscription Management</h1>
                    <p class="page-subtitle">Manage recurring customer orders</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Subscription Management</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddSubscriptionModal()">+ Add Subscriber</button>
                    </div>
                </div>

                <div class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="card-title">Add New Subscriber</h2>
                    </div>
                    <form id="subscriptionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="subCustomerName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="subPhone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="subEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Product</label>
                                <select class="form-control" id="subProduct" required>
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity per Delivery</label>
                                <div style="display: flex; align-items: center; gap: var(--space-12); margin-top: var(--space-8);">
                                    <button type="button" class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 24px; padding: 0;" onclick="decreaseSubQty()">‚àí</button>
                                    <input type="number" class="form-control" id="subQuantity" value="1" min="1" step="1" required style="width: 100px; text-align: center; font-size: 24px; font-weight: bold;">
                                    <button type="button" class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 24px; padding: 0;" onclick="increaseSubQty()">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <select class="form-control" id="subFrequency" required>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Bi-weekly">Bi-weekly</option>
                                    <option value="Monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="subStartDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-control" id="subPaymentMethod" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Card">Card</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delivery Days (Select Multiple)</label>
                            <div style="display: flex; gap: var(--space-12); flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Monday"> Monday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Tuesday"> Tuesday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Wednesday"> Wednesday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Thursday"> Thursday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Friday"> Friday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Saturday"> Saturday
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-6);">
                                    <input type="checkbox" name="deliveryDay" value="Sunday"> Sunday
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delivery Address</label>
                            <textarea class="form-control" id="subAddress" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Subscription</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Active Subscriptions</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Frequency</th>
                                    <th>Delivery Days</th>
                                    <th>Next Delivery</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsTableBody">
                                <!-- Subscriptions will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Sales Returns Section -->
            <section class="section" id="returns">
                <div class="page-header">
                    <h1 class="page-title">Sales Returns</h1>
                    <p class="page-subtitle">Manage product returns and refunds</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Eligible Sales for Return</h2>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Retail: Last 1 day | Wholesale: Last 3 days</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer/Shop</th>
                                    <th>Product</th>
                                    <th>Qty Sold</th>
                                    <th>Qty Returned</th>
                                    <th>Available</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="eligibleSalesBody">
                                <!-- Eligible sales will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="card-title">Process Return</h2>
                    </div>
                    <form id="returnsForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Return Date</label>
                                <input type="date" class="form-control" id="returnDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Original Sale ID</label>
                                <input type="text" class="form-control" id="returnSaleId" placeholder="Leave empty for manual entry">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="returnCustomerName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Product</label>
                                <select class="form-control" id="returnProduct" required onchange="updateReturnMaxQuantity()">
                                    <option value="">Select Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity to Return</label>
                                <div style="display: flex; align-items: center; gap: var(--space-12); margin-top: var(--space-8);">
                                    <button type="button" class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 24px; padding: 0;" onclick="decreaseReturnQty()">‚àí</button>
                                    <input type="number" class="form-control" id="returnQuantity" value="1" min="1" readonly style="width: 100px; text-align: center; font-size: 24px; font-weight: bold;">
                                    <button type="button" class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 24px; padding: 0;" onclick="increaseReturnQty()">+</button>
                                </div>
                                <input type="hidden" id="returnMaxQuantity" value="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Return Amount (‚Çπ)</label>
                                <input type="number" class="form-control" id="returnAmount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason</label>
                                <select class="form-control" id="returnReason" required>
                                    <option value="Damaged Product">Damaged Product</option>
                                    <option value="Quality Issue">Quality Issue</option>
                                    <option value="Wrong Product">Wrong Product</option>
                                    <option value="Customer Request">Customer Request</option>
                                    <option value="Expired">Expired</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Refund Method</label>
                                <select class="form-control" id="returnRefundMethod" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Credit Note">Credit Note</option>
                                    <option value="Replacement">Replacement</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="returnNotes"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Process Return</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Returns Statistics</h2>
                    </div>
                    <div class="stats-grid" id="returnsStats">
                        <!-- Returns stats will be populated -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Returns History</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Reason</th>
                                    <th>Refund Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="returnsTableBody">
                                <!-- Returns will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Data Storage
let products = [];
let sales = [];
let inventoryLog = [];
let expenses = [];
let wholesaleCustomers = [];
let returns = [];
let warehouses = [];
let warehouseInventory = [];
let subscriptions = [];
let stockPrepOrders = [];
let currentStockPrepTab = 'today';
let currentSalesTab = 'retail';
let notifications = [];
let currentUser = null;
let showUserMenu = false;

// Demo Accounts
const demoAccounts = [
    {
        id: 1,
        email: 'user@farm.com',
        password: '123',
        name: 'Farmer User',
        role: 'Owner',
        phone: '9876543210',
        farm_name: 'Green Valley Farm'
    },
    {
        id: 2,
        email: 'admin@farm.com',
        password: '123',
        name: 'Admin',
        role: 'Administrator',
        phone: '9876543211',
        farm_name: 'Main Farm'
    }
];
let nextId = {
    product: 1,
    sale: 1,
    inventory: 1,
    expense: 1,
    customer: 1,
    return: 1,
    warehouse: 1,
    subscription: 1,
    order: 1,
    notification: 1
};

// Notification System
function addNotification(type, title, message, details = {}) {
    const notification = {
        id: nextId.notification++,
        type: type,
        title: title,
        message: message,
        details: details,
        timestamp: new Date().toISOString(),
        read: false
    };
    
    notifications.unshift(notification);
    
    // Keep only last 50 notifications
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    updateNotificationBadge();
    showToastNotification(notification);
    renderNotificationList();
}

function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationBadge');
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

function toggleNotifications() {
    const panel = document.getElementById('notificationPanel');
    
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        // Mark all as read
        notifications.forEach(n => n.read = true);
        updateNotificationBadge();
        renderNotificationList();
    } else {
        panel.style.display = 'none';
    }
}

function renderNotificationList() {
    const container = document.getElementById('notificationList');
    
    if (notifications.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: var(--space-32); color: var(--color-text-secondary);">No notifications</div>';
        return;
    }
    
    let html = '';
    notifications.slice(0, 10).forEach(notif => {
        const icon = notif.type === 'sale' ? 'üí∞' : 
                    notif.type === 'return' ? '‚Ü©Ô∏è' : 
                    notif.type === 'expense' ? 'üí≥' : 
                    notif.type === 'subscription' ? 'üîÑ' : 'üìã';
        
        html += `
            <div style="padding: var(--space-12); margin-bottom: var(--space-8); background: ${notif.read ? 'transparent' : 'var(--color-bg-1)'}; border: 1px solid var(--color-border); border-radius: var(--radius-base);">
                <div style="display: flex; gap: var(--space-12); align-items: start;">
                    <span style="font-size: 24px;">${icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">${notif.title}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">${notif.message}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">${getTimeAgo(notif.timestamp)}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showToastNotification(notification) {
    const container = document.getElementById('toastContainer');
    const icon = notification.type === 'sale' ? 'üí∞' : 
                notification.type === 'return' ? '‚Ü©Ô∏è' : 
                notification.type === 'expense' ? 'üí≥' : 
                notification.type === 'subscription' ? 'üîÑ' : 'üìã';
    
    const toast = document.createElement('div');
    toast.style.cssText = 'background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-16); box-shadow: var(--shadow-lg); min-width: 300px; max-width: 400px; animation: slideIn 0.3s ease-out;';
    
    toast.innerHTML = `
        <div style="display: flex; gap: var(--space-12); align-items: start;">
            <span style="font-size: 24px;">${icon}</span>
            <div style="flex: 1;">
                <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">${notification.title}</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">${notification.message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 20px; color: var(--color-text-secondary);">&times;</button>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function clearAllNotifications() {
    notifications = [];
    updateNotificationBadge();
    renderNotificationList();
    document.getElementById('notificationPanel').style.display = 'none';
    showAlert('success', 'All notifications cleared');
}

// Close notification panel when clicking outside
document.addEventListener('click', function(e) {
    const panel = document.getElementById('notificationPanel');
    const btn = document.getElementById('notificationBtn');
    
    if (panel && btn && !panel.contains(e.target) && !btn.contains(e.target)) {
        panel.style.display = 'none';
    }
});

// Check for saved user session (using in-memory storage)
function checkUserSession() {
    // In-memory only - no localStorage
    // Always return false on first load to show login
    return currentUser !== null;
}

// Initialize CRM App (after user logs in)
function initializeCRMApp() {
    // Set today's date in all date fields
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.value = today;
    });

    // Load warehouses first
    loadSampleWarehouses();
    
    // Load sample data AFTER warehouses
    loadSampleData();
    
    // Setup event listeners
    setupEventListeners();

    // Update date time
    updateDateTime();
    
    // Update user profile display
    updateUserProfileDisplay();

    // CRITICAL FIX: Ensure dashboard renders with all metrics visible immediately
    // Dashboard should already be active, just render it
    renderDashboard();
}

// Initialize App
function initializeApp() {
    // Check if user is logged in
    if (!checkUserSession()) {
        showLoginPage();
        return;
    }
    
    // User is logged in, show CRM
    showCRMApp();
    initializeCRMApp();
}

// Show Login Page
function showLoginPage() {
    // CRITICAL FIX: Hide CRM, show login overlay instead of replacing body
    const existingAppContainer = document.querySelector('.app-container');
    if (existingAppContainer) {
        existingAppContainer.style.display = 'none';
    }
    
    // Create login overlay
    const loginOverlay = document.createElement('div');
    loginOverlay.id = 'loginOverlay';
    loginOverlay.innerHTML = `
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%); font-family: var(--font-family-base);">
            <div style="background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-32); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 420px; width: 90%; animation: fadeIn 0.5s ease-out;">
                <div style="text-align: center; margin-bottom: var(--space-32);">
                    <div style="font-size: 64px; margin-bottom: var(--space-16); line-height: 1;">üçÑ</div>
                    <h1 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--space-8);">Mushroom CRM</h1>
                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-base);">Login to Your Farm</p>
                </div>
                
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group" style="margin-bottom: var(--space-16);">
                        <label class="form-label" style="display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); color: var(--color-text);">Email</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="user@farm.com" required style="width: 100%; padding: var(--space-12); font-size: var(--font-size-base); border: 1px solid var(--color-border); border-radius: var(--radius-base); background-color: var(--color-surface); color: var(--color-text);">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: var(--space-20);">
                        <label class="form-label" style="display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); color: var(--color-text);">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" required style="width: 100%; padding: var(--space-12); font-size: var(--font-size-base); border: 1px solid var(--color-border); border-radius: var(--radius-base); background-color: var(--color-surface); color: var(--color-text);">
                    </div>
                    
                    <div id="loginError" style="display: none; padding: var(--space-12); background-color: rgba(var(--color-error-rgb), 0.15); color: var(--color-error); border: 1px solid rgba(var(--color-error-rgb), 0.25); border-radius: var(--radius-base); margin-bottom: var(--space-16); font-size: var(--font-size-sm);"></div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: var(--space-12); display: inline-flex; align-items: center; justify-content: center; gap: var(--space-8); padding: var(--space-12) var(--space-20); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); border: none; border-radius: var(--radius-base); cursor: pointer; background: linear-gradient(135deg, #1a7346 0%, #22a35f 100%); color: white; box-shadow: 0 2px 8px rgba(26, 115, 70, 0.25);">
                        Login
                    </button>
                    
                    <button type="button" onclick="fillDemoCredentials()" class="btn btn-secondary" style="width: 100%; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-8); padding: var(--space-12) var(--space-20); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); border: 1px solid var(--color-border); border-radius: var(--radius-base); cursor: pointer; background-color: var(--color-secondary); color: var(--color-text);">
                        Demo Account
                    </button>
                    
                    <div style="text-align: center; margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-1); border-radius: var(--radius-base); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        <strong>Demo:</strong> user@farm.com / 123
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(loginOverlay);
}

// Handle Login
function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    // Find user in demo accounts
    const user = demoAccounts.find(
        account => account.email === email && account.password === password
    );
    
    if (user) {
        // CRITICAL FIX: Save user to global variable (no localStorage)
        currentUser = user;
        
        // CRITICAL FIX: Remove login overlay and show CRM
        const loginOverlay = document.getElementById('loginOverlay');
        if (loginOverlay) {
            loginOverlay.remove();
        }
        
        const appContainer = document.querySelector('.app-container');
        if (appContainer) {
            appContainer.style.display = 'flex';
        }
        
        const mobileToggle = document.getElementById('mobileMenuToggle');
        if (mobileToggle) {
            mobileToggle.style.display = 'block';
        }
        
        // Initialize CRM app and render dashboard immediately
        initializeCRMApp();
    } else {
        // Show error
        errorDiv.textContent = '‚ùå Invalid email or password. Please try again.';
        errorDiv.style.display = 'block';
    }
}

// Fill Demo Credentials
function fillDemoCredentials() {
    document.getElementById('loginEmail').value = 'user@farm.com';
    document.getElementById('loginPassword').value = '123';
    document.getElementById('loginError').style.display = 'none';
}

// Show CRM App
function showCRMApp() {
    // The HTML is already rendered, just make sure app container is visible
    const appContainer = document.querySelector('.app-container');
    if (appContainer) {
        appContainer.style.display = 'flex';
    }
    const mobileToggle = document.getElementById('mobileMenuToggle');
    if (mobileToggle) {
        mobileToggle.style.display = 'block';
    }
}

// Update User Profile Display
function updateUserProfileDisplay() {
    if (!currentUser) return;
    
    const userNameElements = document.querySelectorAll('.user-name');
    const userRoleElements = document.querySelectorAll('.user-role');
    const userAvatarElements = document.querySelectorAll('.user-avatar');
    
    userNameElements.forEach(el => el.textContent = currentUser.name);
    userRoleElements.forEach(el => el.textContent = currentUser.role);
    
    // Update avatar with initials
    const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    userAvatarElements.forEach(el => el.textContent = initials);
    
    // Update welcome section
    const welcomeSection = document.querySelector('.welcome-section h2');
    if (welcomeSection) {
        welcomeSection.textContent = `Welcome back, ${currentUser.name} üëã`;
    }
}

// Toggle User Menu
function toggleUserMenu() {
    showUserMenu = !showUserMenu;
    
    const existingMenu = document.getElementById('userDropdownMenu');
    if (existingMenu) {
        existingMenu.remove();
        showUserMenu = false;
        return;
    }
    
    if (showUserMenu) {
        const menu = document.createElement('div');
        menu.id = 'userDropdownMenu';
        menu.style.cssText = 'position: fixed; top: 70px; right: 20px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 1000; min-width: 280px; animation: fadeIn 0.2s ease-out;';
        
        const loginTime = new Date().toLocaleString('en-IN', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        menu.innerHTML = `
            <div style="padding: var(--space-20); border-bottom: 1px solid var(--color-border);">
                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-8);">Welcome, ${currentUser.name}</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Email: ${currentUser.email}</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Role: ${currentUser.role}</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Logged in: ${loginTime}</div>
            </div>
            <div style="padding: var(--space-12);">
                <button onclick="handleLogout()" class="btn btn-danger" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: var(--space-8); padding: var(--space-10) var(--space-16); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); border: none; border-radius: var(--radius-base); cursor: pointer; background-color: var(--color-error); color: var(--color-white); box-shadow: 0 2px 8px rgba(192, 21, 47, 0.25);">
                    üö™ Logout
                </button>
            </div>
        `;
        
        document.body.appendChild(menu);
    }
}

// Handle Logout
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        // Clear user data (in-memory only)
        currentUser = null;
        
        // Clear user menu
        const userMenu = document.getElementById('userDropdownMenu');
        if (userMenu) {
            userMenu.remove();
            showUserMenu = false;
        }
        
        // Hide CRM and show login page
        const appContainer = document.querySelector('.app-container');
        if (appContainer) {
            appContainer.style.display = 'none';
        }
        const mobileToggle = document.getElementById('mobileMenuToggle');
        if (mobileToggle) {
            mobileToggle.style.display = 'none';
        }
        
        // Show login page
        showLoginPage();
        
        // Show notification
        showAlert('success', 'Logged out successfully!');
    }
}

// Close user menu when clicking outside
document.addEventListener('click', function(e) {
    const userProfile = document.querySelector('.user-profile');
    const userMenu = document.getElementById('userDropdownMenu');
    
    if (userMenu && userProfile && !userProfile.contains(e.target) && !userMenu.contains(e.target)) {
        userMenu.remove();
        showUserMenu = false;
    }
});

// Update Date Time
function updateDateTime() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    const dateTimeStr = now.toLocaleDateString('en-IN', options);
    const subtitle = document.getElementById('currentDateTime');
    if (subtitle) {
        subtitle.textContent = dateTimeStr;
    }
    const welcomeDateTime = document.getElementById('currentDateTimeWelcome');
    if (welcomeDateTime) {
        welcomeDateTime.textContent = dateTimeStr;
    }
    // Update every minute
    setTimeout(updateDateTime, 60000);
}

// Load Sample Warehouses
function loadSampleWarehouses() {
    const sampleWarehouses = [
        { name: 'Main Store', location: 'Mangalapuram', capacity: 500, manager: 'Ramesh', managerContact: '9876543210', status: 'Active', createdAt: new Date(2025, 0, 5).toISOString() },
        { name: 'Cold Storage', location: 'Market Road', capacity: 300, manager: 'Suresh', managerContact: '9876543211', status: 'Active', createdAt: new Date(2025, 0, 4).toISOString() },
        { name: 'Secondary Warehouse', location: 'Industrial Area', capacity: 400, manager: 'Rajesh', managerContact: '9876543212', status: 'Active', createdAt: new Date(2025, 0, 3).toISOString() }
    ];

    sampleWarehouses.forEach(w => {
        warehouses.push({
            id: nextId.warehouse++,
            ...w
        });
    });
}

// Load Sample Data
function loadSampleData() {
    // Sample Products (simplified - no category, stock, restock level)
    const sampleProducts = [
        { name: 'Button Mushroom', unit: 'kg', retailPrice: 280, wholesalePrice: 200 },
        { name: 'Oyster Mushroom', unit: 'kg', retailPrice: 320, wholesalePrice: 240 },
        { name: 'Shiitake Mushroom', unit: 'kg', retailPrice: 500, wholesalePrice: 380 },
        { name: 'Mixed Mushroom', unit: 'box', retailPrice: 450, wholesalePrice: 350 },
        { name: 'Mushroom Spawn', unit: 'box', retailPrice: 150, wholesalePrice: 120 }
    ];

    sampleProducts.forEach((p, idx) => {
        products.push({
            id: nextId.product++,
            ...p,
            active: true,
            currentStock: 0,
            createdAt: new Date(Date.now() - idx * 24 * 60 * 60 * 1000).toISOString()
        });
    });

    // Create warehouse inventory for each product
    products.forEach(product => {
        warehouses.forEach((warehouse, idx) => {
            const initialStock = idx === 0 ? 45 : idx === 1 ? 30 : 15;
            warehouseInventory.push({
                id: nextId.inventory++,
                warehouseId: warehouse.id,
                warehouseName: warehouse.name,
                productId: product.id,
                productName: product.name,
                quantity: initialStock,
                lastUpdated: new Date().toISOString().split('T')[0]
            });
            product.currentStock += initialStock;
        });
    });

    // Sample Subscriptions
    const sampleSubs = [
        { customerName: 'Patel Family', phone: '9876543220', email: 'patel@example.com', productName: 'Button Mushroom', quantity: 4, frequency: 'Weekly', deliveryDays: ['Monday', 'Thursday'], address: '123 Main St', paymentMethod: 'UPI' },
        { customerName: 'ABC Restaurants', phone: '9876543221', email: 'abc@restaurant.com', productName: 'Oyster Mushroom', quantity: 8, frequency: 'Weekly', deliveryDays: ['Tuesday', 'Friday'], address: '456 Restaurant Row', paymentMethod: 'Bank Transfer' },
        { customerName: 'Fresh Market Store', phone: '9876543222', email: 'fresh@market.com', productName: 'Shiitake Mushroom', quantity: 10, frequency: 'Weekly', deliveryDays: ['Wednesday'], address: '789 Market Place', paymentMethod: 'Credit' }
    ];

    sampleSubs.forEach((sub, idx) => {
        const product = products.find(p => p.name === sub.productName);
        if (product) {
            subscriptions.push({
                id: nextId.subscription++,
                customerName: sub.customerName,
                phone: sub.phone,
                email: sub.email,
                productId: product.id,
                productName: product.name,
                quantity: sub.quantity,
                frequency: sub.frequency,
                deliveryDays: sub.deliveryDays,
                address: sub.address,
                paymentMethod: sub.paymentMethod,
                startDate: new Date(2025, 10, 1).toISOString().split('T')[0], // Nov 1, 2025
                status: 'Active',
                createdAt: new Date(2025, 10, 1 - idx).toISOString()
            });
        }
    });

    // Generate stock prep orders from subscriptions
    generateStockPrepFromSubscriptions();

    // Sample Sales (current month - November 2025)
    const customers = ['Rahul Sharma', 'Priya Patel', 'Green Mart', 'Fresh Foods Co', 'Amit Kumar', 'Sunita Devi', 'City Grocery', 'Organic Store'];
    const phones = ['9876543210', '9876543211', '9876543212', '9876543213', '9876543214', '9876543215', '9876543216', '9876543217'];

    // Generate sales for November 2025 (current month)
    const salesDate = new Date(2025, 10, 10); // November 10, 2025
    for (let i = 0; i < 30; i++) {
        const product = products[Math.floor(Math.random() * products.length)];
        const saleType = Math.random() > 0.7 ? 'Wholesale' : 'Retail';
        const unitPrice = saleType === 'Wholesale' ? product.wholesalePrice : product.retailPrice;
        const quantity = Math.floor(Math.random() * 10) + 1;
        const date = new Date(2025, 10, Math.floor(Math.random() * 10) + 1); // Nov 1-10, 2025

        sales.push({
            id: nextId.sale++,
            date: date.toISOString().split('T')[0],
            customerName: customers[Math.floor(Math.random() * customers.length)],
            customerPhone: phones[Math.floor(Math.random() * phones.length)],
            productId: product.id,
            productName: product.name,
            quantity: quantity,
            unitPrice: unitPrice,
            totalAmount: quantity * unitPrice,
            paymentMethod: ['Cash', 'UPI', 'Card', 'Bank Transfer'][Math.floor(Math.random() * 4)],
            saleType: saleType,
            notes: '',
            quantityReturned: 0
        });
    }

    // Sample Expenses (current month - November 2025)
    const expenseCategories = ['Raw Materials', 'Labor', 'Utilities', 'Transportation', 'Packaging'];
    const vendors = ['ABC Suppliers', 'XYZ Co', 'Local Market', 'Transport Services', 'Staff'];

    for (let i = 0; i < 15; i++) {
        const category = expenseCategories[Math.floor(Math.random() * expenseCategories.length)];
        const date = new Date(2025, 10, Math.floor(Math.random() * 10) + 1); // Nov 1-10, 2025

        expenses.push({
            id: nextId.expense++,
            date: date.toISOString().split('T')[0],
            category: category,
            description: `${category} expense`,
            amount: Math.floor(Math.random() * 5000) + 500,
            paymentMethod: ['Cash', 'Bank Transfer', 'UPI'][Math.floor(Math.random() * 3)],
            vendor: vendors[Math.floor(Math.random() * vendors.length)],
            notes: '',
            createdAt: date.toISOString()
        });
    }

    // Sample Inventory Logs (November 2025)
    products.forEach(product => {
        const date = new Date(2025, 9, 26); // Oct 26, 2025 (before current month)

        inventoryLog.push({
            id: nextId.inventory++,
            date: date.toISOString().split('T')[0],
            productId: product.id,
            productName: product.name,
            quantityChange: product.currentStock,
            transactionType: 'Purchase',
            cost: product.wholesalePrice * 0.8,
            source: 'Initial Stock',
            notes: 'Opening inventory'
        });
    });

    // Sample Returns (current month - November 2025)
    const returnReasons = ['Damaged Product', 'Quality Issue', 'Customer Request'];
    for (let i = 0; i < 3; i++) {
        const sale = sales[Math.floor(Math.random() * sales.length)];
        const date = new Date(2025, 10, Math.floor(Math.random() * 10) + 1); // Nov 1-10, 2025

        returns.push({
            id: nextId.return++,
            returnDate: date.toISOString().split('T')[0],
            originalSaleId: sale.id,
            customerName: sale.customerName,
            productId: sale.productId,
            productName: sale.productName,
            quantityReturned: Math.min(sale.quantity, 2),
            returnAmount: sale.unitPrice * Math.min(sale.quantity, 2),
            reason: returnReasons[Math.floor(Math.random() * returnReasons.length)],
            refundMethod: ['Cash', 'Credit Note', 'Replacement'][Math.floor(Math.random() * 3)],
            notes: ''
        });
    }

    // Sample Wholesale Customers
    const wholesaleCustomersData = [
        { name: 'Green Mart', businessName: 'Green Mart Pvt Ltd', phone: '9876543212', email: 'contact@greenmart.com', address: '123 Market Street', creditLimit: 50000, outstandingBalance: 0 },
        { name: 'Fresh Foods Co', businessName: 'Fresh Foods Company', phone: '9876543213', email: 'info@freshfoods.com', address: '456 Business Park', creditLimit: 75000, outstandingBalance: 0 },
        { name: 'City Grocery', businessName: 'City Grocery Chain', phone: '9876543216', email: 'orders@citygrocery.com', address: '789 Main Road', creditLimit: 100000, outstandingBalance: 0 }
    ];

    wholesaleCustomersData.forEach((c, idx) => {
        wholesaleCustomers.push({
            id: nextId.customer++,
            ...c,
            createdAt: new Date(Date.now() - idx * 24 * 60 * 60 * 1000).toISOString()
        });
    });
}

// Setup Event Listeners
function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            navigateToSection(section);
        });
    });

    // Mobile menu toggle
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const sidebar = document.getElementById('sidebar');
    mobileToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });

    // Forms
    document.getElementById('retailSalesForm').addEventListener('submit', handleRetailSaleSubmit);
    document.getElementById('wholesaleSalesForm').addEventListener('submit', handleWholesaleSaleSubmit);
    document.getElementById('productsForm').addEventListener('submit', handleProductSubmit);
    document.getElementById('inventoryForm').addEventListener('submit', handleInventorySubmit);
    document.getElementById('expensesForm').addEventListener('submit', handleExpenseSubmit);
    document.getElementById('wholesaleCustomerForm').addEventListener('submit', handleWholesaleCustomerSubmit);
    document.getElementById('returnsForm').addEventListener('submit', handleReturnSubmit);
    document.getElementById('subscriptionForm').addEventListener('submit', handleSubscriptionSubmit);

    // Filters
    document.getElementById('salesSearch').addEventListener('input', renderSalesTable);
    document.getElementById('salesTypeFilter').addEventListener('change', renderSalesTable);
    document.getElementById('expenseCategoryFilter').addEventListener('change', renderExpensesTable);
    document.getElementById('analyticsPeriod').addEventListener('change', renderAnalytics);
    document.getElementById('plPeriod').addEventListener('change', renderProfitLoss);
}

// Navigation
function navigateToSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });

    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });

    // Show selected section
    document.getElementById(sectionName).classList.add('active');

    // Add active class to selected nav link
    document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

    // Hide mobile menu
    document.getElementById('sidebar').classList.remove('active');

    // Render section content
    renderSectionContent(sectionName);
}

function renderSectionContent(sectionName) {
    // Ensure section is visible first
    const section = document.getElementById(sectionName);
    if (!section) {
        console.error('Section not found:', sectionName);
        return;
    }
    
    // CRITICAL FIX: Render immediately for all sections
    switch(sectionName) {
        case 'dashboard':
            // Dashboard renders with all data immediately
            renderDashboard();
            break;
            case 'sales':
                renderSalesSection();
                break;
            case 'inventory':
                renderInventorySection();
                break;
            case 'products':
                renderProductsSection();
                break;
            case 'wholesale':
                renderWholesaleSection();
                break;
            case 'analytics':
                renderAnalytics();
                break;
            case 'expenses':
                renderExpensesSection();
                break;
            case 'profitloss':
                renderProfitLoss();
                break;
            case 'returns':
                renderReturnsSection();
                break;
            case 'stockprep':
                renderStockPrepSection();
                break;
            case 'subscriptions':
                renderSubscriptionsSection();
                break;
        }
}

// Generate Stock Prep Orders from Subscriptions
function generateStockPrepFromSubscriptions() {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const todayName = dayNames[today.getDay()];
    const tomorrowName = dayNames[tomorrow.getDay()];
    
    stockPrepOrders = [];
    
    subscriptions.forEach(sub => {
        if (sub.status === 'Active') {
            if (sub.deliveryDays.includes(todayName)) {
                stockPrepOrders.push({
                    id: nextId.order++,
                    date: today.toISOString().split('T')[0],
                    sourceType: 'Subscription',
                    customerName: sub.customerName,
                    productName: sub.productName,
                    quantity: sub.quantity,
                    address: sub.address,
                    status: 'Pending',
                    notes: `Recurring - ${sub.frequency}`
                });
            }
            if (sub.deliveryDays.includes(tomorrowName)) {
                stockPrepOrders.push({
                    id: nextId.order++,
                    date: tomorrow.toISOString().split('T')[0],
                    sourceType: 'Subscription',
                    customerName: sub.customerName,
                    productName: sub.productName,
                    quantity: sub.quantity,
                    address: sub.address,
                    status: 'Pending',
                    notes: `Recurring - ${sub.frequency}`
                });
            }
        }
    });
}

// Stock Prep Tab Switching
function switchStockPrepTab(tab) {
    currentStockPrepTab = tab;
    document.getElementById('todayTabBtn').style.borderBottom = tab === 'today' ? '3px solid var(--color-primary)' : 'none';
    document.getElementById('tomorrowTabBtn').style.borderBottom = tab === 'tomorrow' ? '3px solid var(--color-primary)' : 'none';
    renderStockPrepContent();
}

// Sales Tab Switching
function switchSalesTab(tab) {
    currentSalesTab = tab;
    document.getElementById('retailTabBtn').style.borderBottom = tab === 'retail' ? '3px solid var(--color-primary)' : 'none';
    document.getElementById('wholesaleTabBtn').style.borderBottom = tab === 'wholesale' ? '3px solid var(--color-primary)' : 'none';
    
    if (tab === 'retail') {
        document.getElementById('retailSalesForm').style.display = 'block';
        document.getElementById('wholesaleSalesForm').style.display = 'none';
    } else {
        document.getElementById('retailSalesForm').style.display = 'none';
        document.getElementById('wholesaleSalesForm').style.display = 'block';
        // Initialize with one line item if empty
        if (document.getElementById('wholesaleLineItems').children.length === 0) {
            addWholesaleLineItem();
        }
    }
}

// Stock Prep Section
function renderStockPrepSection() {
    renderStockPrepContent();
}

function renderStockPrepContent() {
    const targetDate = currentStockPrepTab === 'today' ? new Date().toISOString().split('T')[0] : 
                      (() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; })();
    
    const orders = stockPrepOrders.filter(o => o.date === targetDate);
    
    const totalBoxes = orders.reduce((sum, o) => sum + o.quantity, 0);
    
    let html = `
        <div style="padding: var(--space-16); background: var(--color-bg-3); margin: var(--space-16); border-radius: var(--radius-base);">
            <strong>Total boxes needed: ${totalBoxes}</strong>
        </div>
        <div class="table-container" style="margin: var(--space-16);">
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Source</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    orders.forEach(order => {
        const badgeClass = order.status === 'Prepared' ? 'badge-success' : order.status === 'Delivered' ? 'badge-info' : 'badge-warning';
        html += `
            <tr>
                <td>${order.customerName}</td>
                <td>${order.productName}</td>
                <td>${order.quantity}</td>
                <td><span class="badge badge-info">${order.sourceType}</span></td>
                <td>${order.address}</td>
                <td><span class="badge ${badgeClass}">${order.status}</span></td>
                <td>
                    <div class="action-buttons">
                        ${order.status === 'Pending' ? `<button class="btn btn-small btn-success" onclick="markOrderPrepared(${order.id})">Mark Prepared</button>` : ''}
                        ${order.status === 'Prepared' ? `<button class="btn btn-small btn-primary" onclick="markOrderDelivered(${order.id})">Mark Delivered</button>` : ''}
                        ${order.status === 'Delivered' ? '<span class="badge badge-success">‚úì Delivered</span>' : ''}
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    if (orders.length === 0) {
        html = '<div style="text-align: center; padding: var(--space-32); color: var(--color-text-secondary);">No orders for ' + currentStockPrepTab + '</div>';
    }
    
    document.getElementById('stockPrepContent').innerHTML = html;
}

function markOrderPrepared(orderId) {
    const order = stockPrepOrders.find(o => o.id === orderId);
    if (order) {
        order.status = 'Prepared';
        renderStockPrepContent();
        showAlert('success', 'Order marked as prepared!');
    }
}

function markOrderDelivered(orderId) {
    const order = stockPrepOrders.find(o => o.id === orderId);
    if (order) {
        order.status = 'Delivered';
        renderStockPrepContent();
        showAlert('success', 'Order marked as delivered!');
    }
}

// Subscriptions Section
function renderSubscriptionsSection() {
    populateProductDropdown('subProduct');
    renderSubscriptionsTable();
}

function renderSubscriptionsTable() {
    // Sort subscriptions by createdAt descending (latest first)
    const sortedSubs = [...subscriptions].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
    });
    
    let html = '';
    sortedSubs.forEach(sub => {
        const nextDelivery = getNextDeliveryDate(sub.deliveryDays);
        const badgeClass = sub.status === 'Active' ? 'badge-success' : sub.status === 'Paused' ? 'badge-warning' : 'badge-danger';
        html += `
            <tr>
                <td>${sub.customerName}</td>
                <td>${sub.productName}</td>
                <td>${sub.quantity}</td>
                <td>${sub.frequency}</td>
                <td>${sub.deliveryDays.join(', ')}</td>
                <td>${nextDelivery}</td>
                <td><span class="badge ${badgeClass}">${sub.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon" onclick="editSubscription(${sub.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="toggleSubscriptionStatus(${sub.id})" title="${sub.status === 'Active' ? 'Pause' : 'Resume'}">${sub.status === 'Active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                        <button class="btn-icon" onclick="deleteSubscription(${sub.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    document.getElementById('subscriptionsTableBody').innerHTML = html || '<tr><td colspan="8" class="text-center">No subscriptions found</td></tr>';
}

function getNextDeliveryDate(deliveryDays) {
    const today = new Date();
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const todayIdx = today.getDay();
    
    for (let i = 0; i < 7; i++) {
        const checkIdx = (todayIdx + i) % 7;
        if (deliveryDays.includes(dayNames[checkIdx])) {
            const nextDate = new Date(today);
            nextDate.setDate(nextDate.getDate() + i);
            return formatDate(nextDate.toISOString().split('T')[0]);
        }
    }
    return '-';
}

function decreaseSubQty() {
    const qtyInput = document.getElementById('subQuantity');
    let currentQty = parseInt(qtyInput.value) || 1;
    if (currentQty > 1) {
        qtyInput.value = currentQty - 1;
    }
}

function increaseSubQty() {
    const qtyInput = document.getElementById('subQuantity');
    let currentQty = parseInt(qtyInput.value) || 1;
    qtyInput.value = currentQty + 1;
}

function handleSubscriptionSubmit(e) {
    e.preventDefault();
    
    const deliveryDayCheckboxes = document.querySelectorAll('input[name="deliveryDay"]:checked');
    const deliveryDays = Array.from(deliveryDayCheckboxes).map(cb => cb.value);
    
    if (deliveryDays.length === 0) {
        showAlert('error', 'Please select at least one delivery day!');
        return;
    }
    
    const productId = parseInt(document.getElementById('subProduct').value);
    const product = products.find(p => p.id === productId);
    
    const subscription = {
        id: nextId.subscription++,
        customerName: document.getElementById('subCustomerName').value,
        phone: document.getElementById('subPhone').value,
        email: document.getElementById('subEmail').value,
        productId: productId,
        productName: product.name,
        quantity: parseInt(document.getElementById('subQuantity').value),
        frequency: document.getElementById('subFrequency').value,
        deliveryDays: deliveryDays,
        address: document.getElementById('subAddress').value,
        paymentMethod: document.getElementById('subPaymentMethod').value,
        startDate: document.getElementById('subStartDate').value,
        status: 'Active'
    };
    
    subscriptions.push(subscription);
    generateStockPrepFromSubscriptions();
    
    // Add notification
    addNotification('subscription', 'New Subscription Created', 
        `${subscription.customerName} - ${subscription.productName}, Qty: ${subscription.quantity}, ${subscription.frequency}`,
        { subscriptionId: subscription.id });
    
    showAlert('success', 'Subscription added successfully!');
    document.getElementById('subscriptionForm').reset();
    document.getElementById('subStartDate').value = new Date().toISOString().split('T')[0];
    renderSubscriptionsTable();
}

function toggleSubscriptionStatus(id) {
    const sub = subscriptions.find(s => s.id === id);
    if (sub) {
        const newStatus = sub.status === 'Active' ? 'Paused' : 'Active';
        const action = newStatus === 'Active' ? 'resume' : 'pause';
        
        if (confirm(`Are you sure you want to ${action} this subscription?`)) {
            sub.status = newStatus;
            generateStockPrepFromSubscriptions();
            renderSubscriptionsTable();
            renderStockPrepSection();
            showAlert('success', `Subscription ${newStatus === 'Active' ? 'resumed' : 'paused'} successfully!`);
        }
    }
}

function editSubscription(id) {
    const sub = subscriptions.find(s => s.id === id);
    if (!sub) return;
    
    // Populate form
    document.getElementById('subCustomerName').value = sub.customerName;
    document.getElementById('subPhone').value = sub.phone;
    document.getElementById('subEmail').value = sub.email || '';
    document.getElementById('subProduct').value = sub.productId;
    document.getElementById('subQuantity').value = sub.quantity;
    document.getElementById('subFrequency').value = sub.frequency;
    document.getElementById('subStartDate').value = sub.startDate;
    document.getElementById('subPaymentMethod').value = sub.paymentMethod;
    document.getElementById('subAddress').value = sub.address;
    
    // Check delivery days
    document.querySelectorAll('input[name="deliveryDay"]').forEach(cb => {
        cb.checked = sub.deliveryDays.includes(cb.value);
    });
    
    // Change form to update mode
    const form = document.getElementById('subscriptionForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update Subscription';
    submitBtn.onclick = function(e) {
        e.preventDefault();
        updateSubscription(id);
    };
    
    form.scrollIntoView({ behavior: 'smooth' });
    showAlert('info', 'Edit subscription details and click Update');
}

function updateSubscription(id) {
    const sub = subscriptions.find(s => s.id === id);
    if (!sub) return;
    
    const deliveryDayCheckboxes = document.querySelectorAll('input[name="deliveryDay"]:checked');
    const deliveryDays = Array.from(deliveryDayCheckboxes).map(cb => cb.value);
    
    if (deliveryDays.length === 0) {
        showAlert('error', 'Please select at least one delivery day!');
        return;
    }
    
    const productId = parseInt(document.getElementById('subProduct').value);
    const product = products.find(p => p.id === productId);
    
    sub.customerName = document.getElementById('subCustomerName').value;
    sub.phone = document.getElementById('subPhone').value;
    sub.email = document.getElementById('subEmail').value;
    sub.productId = productId;
    sub.productName = product.name;
    sub.quantity = parseInt(document.getElementById('subQuantity').value);
    sub.frequency = document.getElementById('subFrequency').value;
    sub.deliveryDays = deliveryDays;
    sub.address = document.getElementById('subAddress').value;
    sub.paymentMethod = document.getElementById('subPaymentMethod').value;
    sub.startDate = document.getElementById('subStartDate').value;
    
    generateStockPrepFromSubscriptions();
    showAlert('success', 'Subscription updated successfully!');
    resetSubscriptionForm();
    renderSubscriptionsTable();
    renderStockPrepSection();
}

function resetSubscriptionForm() {
    const form = document.getElementById('subscriptionForm');
    form.reset();
    document.getElementById('subStartDate').value = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[name="deliveryDay"]').forEach(cb => cb.checked = false);
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Add Subscription';
    submitBtn.onclick = null;
}

function deleteSubscription(id) {
    if (confirm('Are you sure you want to delete this subscription? All future orders will be removed.')) {
        subscriptions = subscriptions.filter(s => s.id !== id);
        generateStockPrepFromSubscriptions();
        showAlert('success', 'Subscription deleted successfully!');
        renderSubscriptionsTable();
        renderStockPrepSection();
    }
}

// Warehouse Management
function showAddWarehouseModal() {
    const modalHTML = `
        <div class="modal active" id="warehouseModal" style="align-items: center;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Warehouse</h3>
                    <button class="modal-close" onclick="closeWarehouseModal()">&times;</button>
                </div>
                <form id="warehouseModalForm" onsubmit="submitWarehouse(event)">
                    <div class="form-group">
                        <label class="form-label">Warehouse Name *</label>
                        <input type="text" class="form-control" id="whName" placeholder="Enter warehouse name" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeWarehouseModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeWarehouseModal() {
    const modal = document.getElementById('warehouseModal');
    if (modal) modal.remove();
}

function submitWarehouse(e) {
    e.preventDefault();
    
    const whId = document.getElementById('whId')?.value;
    const warehouseName = document.getElementById('whName').value.trim();
    
    if (!warehouseName) {
        showAlert('error', 'Warehouse name is required!');
        return;
    }
    
    if (whId) {
        // Update existing
        const wh = warehouses.find(w => w.id === parseInt(whId));
        if (wh) {
            const oldName = wh.name;
            wh.name = warehouseName;
            
            // CRITICAL: Update warehouse name in inventory
            warehouseInventory.forEach(inv => {
                if (inv.warehouseId === wh.id) {
                    inv.warehouseName = warehouseName;
                }
            });
            
            // Add notification for warehouse update
            addNotification('warehouse', 'Warehouse Updated', 
                `${oldName} renamed to ${warehouseName}`,
                { warehouseId: wh.id });
            
            showAlert('success', `Warehouse "${oldName}" updated to "${warehouseName}"!`);
        }
    } else {
        // Add new warehouse
        const newWarehouse = {
            id: nextId.warehouse++,
            name: warehouseName,
            location: '',
            capacity: 500,
            manager: '',
            managerContact: '',
            status: 'Active',
            createdAt: new Date().toISOString()
        };
        
        // CRITICAL: Add to warehouses array using unshift to add at top
        warehouses.unshift(newWarehouse);
        
        // Create initial inventory entries for all products in this new warehouse
        products.forEach(product => {
            warehouseInventory.push({
                id: nextId.inventory++,
                warehouseId: newWarehouse.id,
                warehouseName: newWarehouse.name,
                productId: product.id,
                productName: product.name,
                quantity: 0,
                lastUpdated: new Date().toISOString().split('T')[0]
            });
        });
        
        // Add notification for warehouse creation
        addNotification('warehouse', 'Warehouse Added', 
            `${warehouseName} warehouse created successfully`,
            { warehouseId: newWarehouse.id });
        
        showAlert('success', `Warehouse "${warehouseName}" added successfully!`);
    }
    
    closeWarehouseModal();
    
    // CRITICAL FIX: Multiple re-renders to ensure update
    // Immediate render
    renderWarehousesTable();
    
    // Second render after short delay to ensure DOM is updated
    setTimeout(() => {
        renderWarehousesTable();
        populateWarehouseFilter();
        renderInventoryTable();
        populateWarehouseDropdown('inventoryWarehouse');
        populateWarehouseDropdown('modalInventoryWarehouse');
    }, 10);
    
    // Third render to be absolutely sure
    setTimeout(() => {
        renderWarehousesTable();
    }, 100);
}

function editWarehouse(id) {
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) return;
    
    const modalHTML = `
        <div class="modal active" id="warehouseModal" style="align-items: center;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Warehouse</h3>
                    <button class="modal-close" onclick="closeWarehouseModal()">&times;</button>
                </div>
                <form id="warehouseModalForm" onsubmit="submitWarehouse(event)">
                    <input type="hidden" id="whId" value="${warehouse.id}">
                    <div class="form-group">
                        <label class="form-label">Warehouse Name *</label>
                        <input type="text" class="form-control" id="whName" value="${warehouse.name}" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeWarehouseModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function deleteWarehouse(id) {
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) return;
    
    // Count stock in this warehouse
    const stockInWarehouse = warehouseInventory.filter(inv => inv.warehouseId === id);
    const totalStock = stockInWarehouse.reduce((sum, inv) => sum + inv.quantity, 0);
    
    const modalHTML = `
        <div class="modal active" id="deleteWarehouseModal" style="align-items: center;">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h3 class="modal-title">Delete Warehouse</h3>
                    <button class="modal-close" onclick="closeDeleteWarehouseModal()">&times;</button>
                </div>
                <div style="padding: var(--space-16) 0;">
                    <p style="margin-bottom: var(--space-12);">Are you sure you want to delete <strong>${warehouse.name}</strong>?</p>
                    <p style="color: var(--color-warning); font-size: var(--font-size-sm); margin-bottom: var(--space-8);">‚ö†Ô∏è This will also delete all stock in this warehouse:</p>
                    <p style="font-size: var(--font-size-sm); margin-bottom: var(--space-12);">Total stock: <strong>${totalStock.toFixed(1)} units</strong></p>
                    <p style="color: var(--color-error); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold);">This action cannot be undone!</p>
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteWarehouseModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteWarehouse(${id})">Delete</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeDeleteWarehouseModal() {
    const modal = document.getElementById('deleteWarehouseModal');
    if (modal) modal.remove();
}

function confirmDeleteWarehouse(id) {
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) return;
    
    const warehouseName = warehouse.name;
    
    // Remove all stock in that warehouse and update product totals
    const removedStock = warehouseInventory.filter(inv => inv.warehouseId === id);
    removedStock.forEach(inv => {
        const product = products.find(p => p.id === inv.productId);
        if (product) {
            product.currentStock -= inv.quantity;
            // Ensure stock doesn't go negative
            if (product.currentStock < 0) product.currentStock = 0;
        }
    });
    
    // Remove warehouse inventory entries
    warehouseInventory = warehouseInventory.filter(inv => inv.warehouseId !== id);
    
    // Remove warehouse
    warehouses = warehouses.filter(w => w.id !== id);
    
    closeDeleteWarehouseModal();
    showAlert('success', `Warehouse "${warehouseName}" and all its stock deleted successfully!`);
    renderInventorySection();
}

function populateWarehouseDropdown(elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Warehouse</option>';
    
    warehouses.forEach(warehouse => {
        const option = document.createElement('option');
        option.value = warehouse.id;
        option.textContent = warehouse.name;
        select.appendChild(option);
    });
}

// Dashboard Rendering
function renderDashboard() {
    // CRITICAL FIX: Calculate metrics immediately with all available data
    // Ensure data is loaded before calculation
    if (products.length === 0 || warehouses.length === 0) {
        console.log('Waiting for data to load...');
        setTimeout(renderDashboard, 50);
        return;
    }
    calculateAndRenderDashboard();
}

function calculateAndRenderDashboard() {
    // Use November 10, 2025 as current date
    const today = new Date(2025, 10, 10);
    const currentMonth = today.getMonth(); // 10 = November
    const currentYear = today.getFullYear(); // 2025

    // Calculate stats for current month (November 2025)
    const monthSales = sales.filter(s => {
        const saleDate = new Date(s.date);
        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
    });

    const totalSales = monthSales.reduce((sum, s) => sum + s.totalAmount, 0);
    const totalInventory = products.reduce((sum, p) => sum + p.currentStock, 0);
    const monthExpenses = expenses.filter(e => {
        const expDate = new Date(e.date);
        return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
    });
    const totalExpenses = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
    const monthProfit = totalSales - totalExpenses;

    const totalBoxesSold = monthSales.reduce((sum, s) => sum + s.quantity, 0);
    const profitGrowth = ((monthProfit - 40720) / 40720 * 100).toFixed(1);
    const salesGrowth = ((totalBoxesSold - 280) / 280 * 100).toFixed(1);
    const expenseChange = ((totalExpenses - 83800) / 83800 * 100).toFixed(1);

    const statsHTML = `
        <div class="stat-card fade-in" style="background: linear-gradient(135deg, rgba(26, 115, 70, 0.1) 0%, rgba(34, 163, 95, 0.05) 100%); border-left: 4px solid #1a7346;">
            <div class="stat-header">
                <span class="stat-label">Current Month Profit</span>
                <span class="stat-icon">üí∞</span>
            </div>
            <div class="stat-value">‚Çπ${animateNumber(monthProfit)}</div>
            <div class="stat-change ${profitGrowth >= 0 ? 'positive' : 'negative'}">
                vs Last Month: ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}% ${profitGrowth >= 0 ? '‚Üë' : '‚Üì'}
            </div>
        </div>
        <div class="stat-card fade-in" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 197, 253, 0.05) 100%); border-left: 4px solid #3b82f6;">
            <div class="stat-header">
                <span class="stat-label">Current Month Sales</span>
                <span class="stat-icon">üì¶</span>
            </div>
            <div class="stat-value">${animateNumber(totalBoxesSold)} Boxes</div>
            <div class="stat-change positive">
                ${salesGrowth}% increase from last month
            </div>
        </div>
        <div class="stat-card fade-in" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(196, 181, 253, 0.05) 100%); border-left: 4px solid #8b5cf6;">
            <div class="stat-header">
                <span class="stat-label">Active Subscriptions</span>
                <span class="stat-icon">üîÑ</span>
            </div>
            <div class="stat-value">${subscriptions.filter(s => s.status === 'Active').length} Active</div>
            <div class="stat-change">
                Next delivery tomorrow
            </div>
        </div>
        <div class="stat-card fade-in" style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(254, 215, 170, 0.05) 100%); border-left: 4px solid #f97316;">
            <div class="stat-header">
                <span class="stat-label">Current Month Expenses</span>
                <span class="stat-icon">üí∏</span>
            </div>
            <div class="stat-value">‚Çπ${animateNumber(totalExpenses)}</div>
            <div class="stat-change ${expenseChange < 0 ? 'positive' : 'negative'}">
                vs Last Month: ${expenseChange < 0 ? '' : '+'}${expenseChange}% ${expenseChange < 0 ? '‚Üì' : '‚Üë'}
            </div>
        </div>
    `;

    document.getElementById('dashboardStats').innerHTML = statsHTML;

    // Overall Profit Banner
    const profitBanner = document.getElementById('profitBanner');
    if (monthProfit < 0) {
        profitBanner.style.background = 'linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #f87171 100%)';
    }
    document.getElementById('overallProfitValue').textContent = `‚Çπ${monthProfit.toLocaleString('en-IN', {maximumFractionDigits: 2})}`;
    document.getElementById('overallProfitSubtitle').textContent = `vs Last Month: ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}% ${profitGrowth >= 0 ? '‚Üë' : '‚Üì'}`;
    
    const breakdownHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">Income</div>
            <div class="breakdown-value">‚Çπ${totalSales.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Expenses</div>
            <div class="breakdown-value">‚Çπ${totalExpenses.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Profit</div>
            <div class="breakdown-value">‚Çπ${monthProfit.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
        </div>
    `;
    document.getElementById('profitBreakdown').innerHTML = breakdownHTML;

    // Sales Line Chart with Chart.js
    renderSalesLineChart(monthSales);

    // Expense Pie Chart with Chart.js
    renderExpensePieChartJS(monthExpenses);

    // Recent transactions with improved design
    const recentSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
    let transactionsHTML = '';
    recentSales.forEach(sale => {
        const initials = sale.customerName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const timeAgo = getTimeAgo(sale.date);
        transactionsHTML += `
            <div class="transaction-item">
                <div class="transaction-left">
                    <div class="transaction-avatar">${initials}</div>
                    <div class="transaction-info">
                        <h4>${sale.customerName}</h4>
                        <p>${sale.productName} ‚Ä¢ ${sale.quantity} units ‚Ä¢ <span class="badge ${sale.saleType === 'Retail' ? 'badge-info' : 'badge-success'}" style="padding: 2px 8px; font-size: 10px;">${sale.saleType}</span></p>
                    </div>
                </div>
                <div class="transaction-right">
                    <div class="transaction-amount">‚Çπ${sale.totalAmount.toLocaleString('en-IN', {maximumFractionDigits: 2})}</div>
                    <div class="transaction-time">${timeAgo}</div>
                </div>
            </div>
        `;
    });
    document.getElementById('recentTransactions').innerHTML = transactionsHTML;

    // Top products
    const productSales = {};
    sales.forEach(sale => {
        if (!productSales[sale.productName]) {
            productSales[sale.productName] = { quantity: 0, revenue: 0 };
        }
        productSales[sale.productName].quantity += sale.quantity;
        productSales[sale.productName].revenue += sale.totalAmount;
    });

    const topProducts = Object.entries(productSales)
        .sort((a, b) => b[1].revenue - a[1].revenue)
        .slice(0, 5);

    let topProductsHTML = '<div class="table-container"><table><thead><tr><th>Product</th><th>Quantity Sold</th><th>Revenue</th></tr></thead><tbody>';
    topProducts.forEach(([name, data]) => {
        topProductsHTML += `
            <tr>
                <td>${name}</td>
                <td>${data.quantity.toFixed(1)}</td>
                <td>‚Çπ${data.revenue.toFixed(2)}</td>
            </tr>
        `;
    });
    topProductsHTML += '</tbody></table></div>';
    document.getElementById('topProducts').innerHTML = topProductsHTML;
}

// Sales Line Chart with Chart.js
let salesChartInstance = null;

function renderSalesLineChart(monthSales) {
    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
    const salesByDay = {};
    
    for (let i = 1; i <= daysInMonth; i++) {
        salesByDay[i] = 0;
    }
    
    monthSales.forEach(sale => {
        const day = new Date(sale.date).getDate();
        salesByDay[day] += sale.quantity;
    });
    
    const labels = Object.keys(salesByDay).map(d => `Day ${d}`);
    const data = Object.values(salesByDay);
    
    const ctx = document.getElementById('salesLineChart');
    
    if (salesChartInstance) {
        salesChartInstance.destroy();
    }
    
    salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Boxes Sold',
                data: data,
                backgroundColor: 'rgba(26, 115, 70, 0.8)',
                borderColor: '#1a7346',
                borderWidth: 2,
                borderRadius: 6,
                hoverBackgroundColor: 'rgba(34, 163, 95, 0.9)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    borderColor: '#1a7346',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: { size: 11 }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 10 },
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 15
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

// Expense Pie Chart with Chart.js
let expenseChartInstance = null;

function renderExpensePieChartJS(monthExpenses) {
    const expensesByCategory = {};
    const colors = ['#1a7346', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#f97316', '#10b981', '#ec4899'];
    
    monthExpenses.forEach(exp => {
        if (!expensesByCategory[exp.category]) {
            expensesByCategory[exp.category] = 0;
        }
        expensesByCategory[exp.category] += exp.amount;
    });
    
    const total = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
    document.getElementById('expenseTotal').textContent = `‚Çπ${total.toLocaleString('en-IN', {maximumFractionDigits: 0})} Total`;
    
    if (total === 0) {
        document.getElementById('expenseLegend').innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">No expenses this month</p>';
        return;
    }
    
    const ctx = document.getElementById('expensePieChart');
    
    if (expenseChartInstance) {
        expenseChartInstance.destroy();
    }
    
    const labels = Object.keys(expensesByCategory);
    const data = Object.values(expensesByCategory);
    
    expenseChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: '#fff',
                hoverBorderWidth: 4,
                hoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ‚Çπ${value.toFixed(0)} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
    
    // Create legend
    let legendHTML = '';
    labels.forEach((label, index) => {
        const amount = data[index];
        const percentage = ((amount / total) * 100).toFixed(1);
        legendHTML += `
            <div class="legend-item">
                <div class="legend-color" style="background: ${colors[index]};"></div>
                <span><strong>${label}:</strong> ‚Çπ${amount.toLocaleString('en-IN', {maximumFractionDigits: 0})} (${percentage}%)</span>
            </div>
        `;
    });
    
    document.getElementById('expenseLegend').innerHTML = legendHTML;
}

// Sales Section
function renderSalesSection() {
    populateProductDropdown('retailProduct');
    renderSalesTable();
    // Initialize wholesale form with one line item
    if (document.getElementById('wholesaleLineItems').children.length === 0) {
        addWholesaleLineItem();
    }
}

function renderSalesTable() {
    const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
    const typeFilter = document.getElementById('salesTypeFilter').value;

    let filteredSales = sales.filter(sale => {
        const matchesSearch = sale.customerName.toLowerCase().includes(searchTerm) || 
                            sale.productName.toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || sale.saleType === typeFilter;
        return matchesSearch && matchesType;
    });

    filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    filteredSales.forEach(sale => {
        const customerDisplay = sale.saleType === 'Wholesale' && sale.vendorAddress ? 
            `${sale.customerName}<br><small style="color: var(--color-text-secondary);">${sale.customerPhone}</small>` : 
            sale.customerName;
        
        html += `
            <tr>
                <td>${formatDate(sale.date)}</td>
                <td>${customerDisplay}</td>
                <td>${sale.productName}</td>
                <td>${sale.quantity}</td>
                <td>‚Çπ${sale.totalAmount.toFixed(2)}</td>
                <td><span class="badge ${sale.saleType === 'Retail' ? 'badge-info' : 'badge-success'}">${sale.saleType}</span></td>
                <td>${sale.paymentMethod}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon" onclick="viewSaleDetails(${sale.id})" title="View">üëÅÔ∏è</button>
                        <button class="btn-icon" onclick="editSale(${sale.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteSale(${sale.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    });

    document.getElementById('salesTableBody').innerHTML = html || '<tr><td colspan="8" class="text-center">No sales found</td></tr>';
}

function viewSaleDetails(id) {
    const sale = sales.find(s => s.id === id);
    if (!sale) return;
    
    let details = `Sale ID: ${sale.id}\n`;
    details += `Date: ${formatDate(sale.date)}\n`;
    details += `Type: ${sale.saleType}\n\n`;
    
    if (sale.saleType === 'Wholesale' && sale.vendorAddress) {
        details += `Vendor/Shop: ${sale.customerName}\n`;
        details += `Contact: ${sale.customerPhone}\n`;
        details += `Address: ${sale.vendorAddress}\n\n`;
    } else {
        details += `Customer: ${sale.customerName}\n`;
        if (sale.customerPhone) details += `Phone: ${sale.customerPhone}\n`;
        details += `\n`;
    }
    
    details += `Product: ${sale.productName}\n`;
    details += `Quantity: ${sale.quantity}\n`;
    details += `Unit Price: ‚Çπ${sale.unitPrice.toFixed(2)}\n`;
    details += `Total Amount: ‚Çπ${sale.totalAmount.toFixed(2)}\n\n`;
    details += `Payment Method: ${sale.paymentMethod}\n`;
    
    if (sale.notes) {
        details += `\nNotes: ${sale.notes}`;
    }
    
    alert(details);
}

function editSale(id) {
    const sale = sales.find(s => s.id === id);
    if (!sale) return;
    
    if (sale.saleType === 'Retail') {
        // Switch to retail tab and populate form
        switchSalesTab('retail');
        
        document.getElementById('retailSaleDate').value = sale.date;
        document.getElementById('retailCustomerName').value = sale.customerName;
        document.getElementById('retailCustomerPhone').value = sale.customerPhone || '';
        document.getElementById('retailProduct').value = sale.productId;
        document.getElementById('retailQuantity').value = sale.quantity;
        document.getElementById('retailUnitPrice').value = sale.unitPrice;
        document.getElementById('retailTotalAmount').value = sale.totalAmount;
        document.getElementById('retailPaymentMethod').value = sale.paymentMethod;
        document.getElementById('retailNotes').value = sale.notes || '';
        
        const form = document.getElementById('retailSalesForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Update Sale';
        submitBtn.onclick = function(e) {
            e.preventDefault();
            updateRetailSale(id);
        };
        
        form.scrollIntoView({ behavior: 'smooth' });
        showAlert('info', 'Edit sale details and click Update Sale');
    } else {
        showAlert('info', 'Wholesale sale editing - please delete and recreate for now');
    }
}

function updateRetailSale(id) {
    const sale = sales.find(s => s.id === id);
    if (!sale) return;
    
    const productId = parseInt(document.getElementById('retailProduct').value);
    const product = products.find(p => p.id === productId);
    const newQuantity = parseInt(document.getElementById('retailQuantity').value);
    const oldQuantity = sale.quantity;
    
    // Restore old inventory
    product.currentStock += oldQuantity;
    const productInv = warehouseInventory.find(inv => inv.productId === sale.productId);
    if (productInv) {
        productInv.quantity += oldQuantity;
    }
    
    // Check new stock
    if (product.currentStock < newQuantity) {
        showAlert('error', 'Insufficient stock available!');
        product.currentStock -= oldQuantity; // Revert
        if (productInv) productInv.quantity -= oldQuantity;
        return;
    }
    
    // Update sale
    sale.date = document.getElementById('retailSaleDate').value;
    sale.customerName = document.getElementById('retailCustomerName').value;
    sale.customerPhone = document.getElementById('retailCustomerPhone').value;
    sale.productId = productId;
    sale.productName = product.name;
    sale.quantity = newQuantity;
    sale.unitPrice = parseFloat(document.getElementById('retailUnitPrice').value);
    sale.totalAmount = parseFloat(document.getElementById('retailTotalAmount').value);
    sale.paymentMethod = document.getElementById('retailPaymentMethod').value;
    sale.notes = document.getElementById('retailNotes').value;
    
    // Update inventory
    product.currentStock -= newQuantity;
    const newProductInv = warehouseInventory.find(inv => inv.productId === productId);
    if (newProductInv) {
        newProductInv.quantity -= newQuantity;
        newProductInv.lastUpdated = sale.date;
    }
    
    showAlert('success', 'Sale updated successfully!');
    resetRetailSaleForm();
    renderSalesTable();
    renderDashboard();
    if (document.getElementById('inventory').classList.contains('active')) {
        renderInventorySection();
    }
}

function resetRetailSaleForm() {
    const form = document.getElementById('retailSalesForm');
    form.reset();
    document.getElementById('retailSaleDate').value = new Date().toISOString().split('T')[0];
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Add Retail Sale';
    submitBtn.onclick = null;
}

// Retail Sale Functions
function updateRetailPrice() {
    const productId = parseInt(document.getElementById('retailProduct').value);
    if (productId) {
        const product = products.find(p => p.id === productId);
        if (product) {
            document.getElementById('retailUnitPrice').value = product.retailPrice;
            calculateRetailTotal();
        }
    }
}

function decreaseRetailQty() {
    const qtyInput = document.getElementById('retailQuantity');
    let currentQty = parseInt(qtyInput.value) || 1;
    if (currentQty > 1) {
        qtyInput.value = currentQty - 1;
        calculateRetailTotal();
    }
}

function increaseRetailQty() {
    const qtyInput = document.getElementById('retailQuantity');
    let currentQty = parseInt(qtyInput.value) || 1;
    qtyInput.value = currentQty + 1;
    calculateRetailTotal();
}

function calculateRetailTotal() {
    const quantity = parseInt(document.getElementById('retailQuantity').value) || 1;
    const unitPrice = parseFloat(document.getElementById('retailUnitPrice').value) || 0;
    document.getElementById('retailTotalAmount').value = (quantity * unitPrice).toFixed(2);
}

function handleRetailSaleSubmit(e) {
    e.preventDefault();

    const productId = parseInt(document.getElementById('retailProduct').value);
    const product = products.find(p => p.id === productId);
    const quantity = parseInt(document.getElementById('retailQuantity').value);

    // Check stock
    if (product.currentStock < quantity) {
        showAlert('error', 'Insufficient stock available!');
        return;
    }

    const sale = {
        id: nextId.sale++,
        date: document.getElementById('retailSaleDate').value,
        customerName: document.getElementById('retailCustomerName').value,
        customerPhone: document.getElementById('retailCustomerPhone').value,
        productId: productId,
        productName: product.name,
        quantity: quantity,
        unitPrice: parseFloat(document.getElementById('retailUnitPrice').value),
        totalAmount: parseFloat(document.getElementById('retailTotalAmount').value),
        paymentMethod: document.getElementById('retailPaymentMethod').value,
        saleType: 'Retail',
        notes: document.getElementById('retailNotes').value,
        returned: false
    };

    sales.push(sale);

    // Update inventory
    product.currentStock -= quantity;
    
    // Update warehouse stock (deduct from first available warehouse)
    const productInv = warehouseInventory.find(inv => inv.productId === product.id && inv.quantity >= quantity);
    if (productInv) {
        productInv.quantity -= quantity;
        productInv.lastUpdated = sale.date;
    }

    // Log inventory change
    inventoryLog.push({
        id: nextId.inventory++,
        date: sale.date,
        productId: product.id,
        productName: product.name,
        quantityChange: -quantity,
        transactionType: 'Sale',
        cost: 0,
        source: sale.customerName,
        notes: `Sale #${sale.id}`
    });

    // Add notification - UPDATED to match expense notification style
    addNotification('sale', 'Sale Recorded', 
        `Customer: ${sale.customerName}, Product: ${sale.productName} x ${sale.quantity}, ‚Çπ${sale.totalAmount.toFixed(2)}`,
        { saleId: sale.id, customer: sale.customerName, product: sale.productName, quantity: sale.quantity, amount: sale.totalAmount });

    showAlert('success', 'Retail sale added successfully!');
    document.getElementById('retailSalesForm').reset();
    document.getElementById('retailSaleDate').value = new Date().toISOString().split('T')[0];
    renderSalesTable();
}

// Wholesale Sale Functions
let wholesaleLineItemCounter = 0;

function addWholesaleLineItem() {
    const lineItemsContainer = document.getElementById('wholesaleLineItems');
    const lineItemId = ++wholesaleLineItemCounter;
    
    const lineItemHTML = `
        <div class="wholesale-line-item" id="lineItem${lineItemId}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: var(--space-12); align-items: end; margin-bottom: var(--space-12); padding: var(--space-12); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base);">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Product</label>
                <select class="form-control wholesale-product" id="wProduct${lineItemId}" required onchange="updateWholesaleLinePrice(${lineItemId})">
                    <option value="">Select Product</option>
                    ${products.map(p => `<option value="${p.id}" data-price="${p.wholesalePrice}">${p.name} (${p.currentStock} ${p.unit})</option>`).join('')}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-control wholesale-quantity" id="wQty${lineItemId}" step="0.1" min="0.1" required oninput="updateWholesaleLineTotal(${lineItemId})">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Unit Price (‚Çπ)</label>
                <input type="number" class="form-control wholesale-unit-price" id="wPrice${lineItemId}" step="0.01" required oninput="updateWholesaleLineTotal(${lineItemId})">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Total (‚Çπ)</label>
                <input type="number" class="form-control wholesale-line-total" id="wTotal${lineItemId}" readonly>
            </div>
            <button type="button" class="btn btn-danger btn-small" onclick="removeWholesaleLineItem(${lineItemId})" style="margin-bottom: 0;" title="Remove">üóëÔ∏è</button>
        </div>
    `;
    
    lineItemsContainer.insertAdjacentHTML('beforeend', lineItemHTML);
}

function updateWholesaleLinePrice(lineItemId) {
    const productSelect = document.getElementById(`wProduct${lineItemId}`);
    const priceInput = document.getElementById(`wPrice${lineItemId}`);
    
    if (productSelect.value) {
        const product = products.find(p => p.id === parseInt(productSelect.value));
        if (product) {
            priceInput.value = product.wholesalePrice;
            updateWholesaleLineTotal(lineItemId);
        }
    }
}

function decreaseWholesaleQty(lineItemId) {
    const qtyInput = document.getElementById(`wQty${lineItemId}`);
    let currentQty = parseInt(qtyInput.value) || 1;
    if (currentQty > 1) {
        qtyInput.value = currentQty - 1;
        updateWholesaleLineTotal(lineItemId);
    }
}

function increaseWholesaleQty(lineItemId) {
    const qtyInput = document.getElementById(`wQty${lineItemId}`);
    let currentQty = parseInt(qtyInput.value) || 1;
    qtyInput.value = currentQty + 1;
    updateWholesaleLineTotal(lineItemId);
}

function updateWholesaleLineTotal(lineItemId) {
    const qty = parseInt(document.getElementById(`wQty${lineItemId}`).value) || 1;
    const price = parseFloat(document.getElementById(`wPrice${lineItemId}`).value) || 0;
    document.getElementById(`wTotal${lineItemId}`).value = (qty * price).toFixed(2);
    calculateWholesaleTotal();
}

function removeWholesaleLineItem(lineItemId) {
    const lineItem = document.getElementById(`lineItem${lineItemId}`);
    if (lineItem) {
        lineItem.remove();
        calculateWholesaleTotal();
    }
}

function calculateWholesaleTotal() {
    const lineItems = document.querySelectorAll('.wholesale-line-item');
    let subtotal = 0;
    
    lineItems.forEach(item => {
        const totalInput = item.querySelector('.wholesale-line-total');
        if (totalInput) {
            subtotal += parseFloat(totalInput.value) || 0;
        }
    });
    
    const discount = parseFloat(document.getElementById('wholesaleDiscount').value) || 0;
    const discountAmount = (subtotal * discount) / 100;
    const total = subtotal - discountAmount;
    
    document.getElementById('wholesaleSubtotal').textContent = '‚Çπ' + subtotal.toFixed(2);
    document.getElementById('wholesaleTotalAmount').textContent = '‚Çπ' + total.toFixed(2);
}

function handleWholesaleSaleSubmit(e) {
    e.preventDefault();
    
    const lineItems = document.querySelectorAll('.wholesale-line-item');
    if (lineItems.length === 0) {
        showAlert('error', 'Please add at least one product!');
        return;
    }
    
    // Get supply days
    const supplyDayCheckboxes = document.querySelectorAll('input[name="wholesaleSupplyDay"]:checked');
    const supplyDays = Array.from(supplyDayCheckboxes).map(cb => cb.value);
    
    const vendorName = document.getElementById('wholesaleVendorName').value;
    const vendorContact = document.getElementById('wholesaleVendorContact').value;
    const vendorAddress = document.getElementById('wholesaleVendorAddress').value;
    const saleDate = document.getElementById('wholesaleSaleDate').value;
    const paymentMethod = document.getElementById('wholesalePaymentMethod').value;
    const notes = document.getElementById('wholesaleNotes').value;
    
    let totalAmount = 0;
    const lineItemsData = [];
    
    // Validate and collect all line items
    for (let item of lineItems) {
        const productSelect = item.querySelector('.wholesale-product');
        const qtyInput = item.querySelector('.wholesale-quantity');
        const priceInput = item.querySelector('.wholesale-unit-price');
        const totalInput = item.querySelector('.wholesale-line-total');
        
        const productId = parseInt(productSelect.value);
        const product = products.find(p => p.id === productId);
        const quantity = parseInt(qtyInput.value);
        
        if (!product || !quantity) {
            showAlert('error', 'Please fill all product details!');
            return;
        }
        
        // Check stock
        if (product.currentStock < quantity) {
            showAlert('error', `Insufficient stock for ${product.name}!`);
            return;
        }
        
        lineItemsData.push({
            productId: productId,
            productName: product.name,
            quantity: quantity,
            unitPrice: parseFloat(priceInput.value),
            total: parseFloat(totalInput.value)
        });
        
        totalAmount += parseFloat(totalInput.value);
    }
    
    // Apply discount
    const discount = parseFloat(document.getElementById('wholesaleDiscount').value) || 0;
    const discountAmount = (totalAmount * discount) / 100;
    totalAmount -= discountAmount;
    
    // Create wholesale sale record for each line item
    lineItemsData.forEach(item => {
        const sale = {
            id: nextId.sale++,
            date: saleDate,
            customerName: vendorName,
            customerPhone: vendorContact,
            vendorAddress: vendorAddress,
            supplyDays: supplyDays,
            productId: item.productId,
            productName: item.productName,
            quantity: parseInt(item.quantity),
            unitPrice: item.unitPrice,
            totalAmount: item.total,
            paymentMethod: paymentMethod,
            saleType: 'Wholesale',
            notes: notes,
            returned: false
        };
        
        sales.push(sale);
        
        // Update inventory
        const product = products.find(p => p.id === item.productId);
        product.currentStock -= item.quantity;
        
        // Update warehouse stock (deduct from first available warehouse)
        const productInv = warehouseInventory.find(inv => inv.productId === item.productId && inv.quantity >= item.quantity);
        if (productInv) {
            productInv.quantity -= item.quantity;
            productInv.lastUpdated = saleDate;
        }
        
        // Log inventory change
        inventoryLog.push({
            id: nextId.inventory++,
            date: saleDate,
            productId: item.productId,
            productName: item.productName,
            quantityChange: -item.quantity,
            transactionType: 'Sale',
            cost: 0,
            source: vendorName,
            notes: `Wholesale Sale #${sale.id}`
        });
    });
    
    // Add notification - UPDATED to match expense notification style
    const itemsText = lineItemsData.length === 1 ? '1 item' : `${lineItemsData.length} items`;
    addNotification('sale', 'Wholesale Order', 
        `Shop: ${vendorName}, Items: ${itemsText}, ‚Çπ${totalAmount.toFixed(2)}`,
        { shop: vendorName, items: lineItemsData.length, amount: totalAmount });
    
    showAlert('success', `Wholesale sale added successfully! Total: ‚Çπ${totalAmount.toFixed(2)}`);
    
    // Reset form
    document.getElementById('wholesaleSalesForm').reset();
    document.getElementById('wholesaleSaleDate').value = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[name="wholesaleSupplyDay"]').forEach(cb => cb.checked = false);
    document.getElementById('wholesaleLineItems').innerHTML = '';
    wholesaleLineItemCounter = 0;
    addWholesaleLineItem();
    calculateWholesaleTotal();
    
    renderSalesTable();
}

function deleteSale(id) {
    if (confirm('Are you sure you want to delete this sale? Inventory will be restored.')) {
        const sale = sales.find(s => s.id === id);
        if (sale && !sale.returned) {
            // Restore inventory
            const product = products.find(p => p.id === sale.productId);
            if (product) {
                product.currentStock += sale.quantity;
                
                // Update warehouse inventory (restore to first warehouse with this product)
                const productInv = warehouseInventory.find(inv => inv.productId === product.id);
                if (productInv) {
                    productInv.quantity += sale.quantity;
                    productInv.lastUpdated = new Date().toISOString().split('T')[0];
                }
            }
        }
        
        sales = sales.filter(s => s.id !== id);
        showAlert('success', 'Sale deleted and inventory restored!');
        renderSalesTable();
        renderDashboard();
        if (document.getElementById('inventory').classList.contains('active')) {
            renderInventorySection();
        }
    }
}

function deleteAllSales() {
    if (confirm('Are you sure you want to delete ALL sales? This action cannot be undone!')) {
        // Restore inventory for all sales
        sales.forEach(sale => {
            if (!sale.returned) {
                const product = products.find(p => p.id === sale.productId);
                if (product) {
                    product.currentStock += sale.quantity;
                }
            }
        });
        
        sales = [];
        showAlert('success', 'All sales deleted successfully!');
        renderSalesTable();
        renderDashboard();
    }
}

// Inventory Section
function renderInventorySection() {
    // Ensure all dropdowns are populated
    populateProductDropdown('inventoryProduct');
    populateWarehouseDropdown('inventoryWarehouse');
    populateWarehouseFilter();
    
    // Render all inventory sections
    renderWarehousesTable();
    renderInventoryTable();
    renderInventoryHistory();
    
    // Also update dropdowns in modals if they exist
    setTimeout(() => {
        populateWarehouseDropdown('modalInventoryWarehouse');
    }, 100);
}

function populateWarehouseFilter() {
    const select = document.getElementById('warehouseFilter');
    if (!select) return;
    
    select.innerHTML = '<option value="">All Warehouses</option>';
    
    warehouses.forEach(warehouse => {
        const option = document.createElement('option');
        option.value = warehouse.id;
        option.textContent = warehouse.name;
        select.appendChild(option);
    });
}

function renderWarehousesTable() {
    // CRITICAL FIX: Force immediate render with current warehouses array
    const tbody = document.getElementById('warehousesTableBody');
    if (!tbody) return;
    
    // Sort warehouses by createdAt descending (latest first)
    const sortedWarehouses = [...warehouses].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
    });
    
    if (sortedWarehouses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-center" style="padding: var(--space-32); color: var(--color-text-secondary);">No warehouses yet. Click "Add Warehouse" to create one.</td></tr>';
        return;
    }
    
    let html = '';
    sortedWarehouses.forEach(warehouse => {
        const stockInWarehouse = warehouseInventory.filter(inv => inv.warehouseId === warehouse.id);
        const totalStock = stockInWarehouse.reduce((sum, inv) => sum + inv.quantity, 0);
        
        html += `
            <tr class="fade-in">
                <td>
                    <strong>${warehouse.name}</strong>
                    <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-4);">
                        Total Stock: ${totalStock.toFixed(1)} units
                    </div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-small btn-secondary" onclick="editWarehouse(${warehouse.id})" title="Edit">‚úèÔ∏è Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteWarehouse(${warehouse.id})" title="Delete">üóëÔ∏è Delete</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    // CRITICAL: Set innerHTML directly
    tbody.innerHTML = html;
}

function renderInventoryTable() {
    const warehouseFilterId = document.getElementById('warehouseFilter')?.value;
    
    let filteredInventory = warehouseInventory;
    if (warehouseFilterId) {
        filteredInventory = warehouseInventory.filter(inv => inv.warehouseId === parseInt(warehouseFilterId));
    }
    
    let html = '';
    filteredInventory.forEach(inv => {
        const product = products.find(p => p.id === inv.productId);
        if (!product) return;
        
        html += `
            <tr>
                <td>${inv.productName}</td>
                <td><strong>${inv.warehouseName}</strong></td>
                <td>${inv.quantity.toFixed(1)} ${product.unit}</td>
                <td>${formatDate(inv.lastUpdated)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-small btn-secondary" onclick="editInventory(${inv.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteInventoryItem(${inv.id})">Delete</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    document.getElementById('inventoryTableBody').innerHTML = html || '<tr><td colspan="5" class="text-center">No inventory</td></tr>';
}

function deleteInventoryItem(id) {
    if (confirm('Are you sure you want to delete this inventory item?')) {
        const inv = warehouseInventory.find(i => i.id === id);
        if (inv) {
            // Update product total stock
            const product = products.find(p => p.id === inv.productId);
            if (product) {
                product.currentStock -= inv.quantity;
            }
            
            warehouseInventory = warehouseInventory.filter(i => i.id !== id);
            showAlert('success', 'Inventory item deleted successfully!');
            renderInventoryTable();
        }
    }
}

function editInventory(id) {
    const inv = warehouseInventory.find(i => i.id === id);
    if (!inv) return;
    
    const modalHTML = `
        <div class="modal active" id="editInventoryModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Inventory - ${inv.productName}</h3>
                    <button class="modal-close" onclick="closeEditInventoryModal()">&times;</button>
                </div>
                <form id="editInventoryForm" onsubmit="updateInventory(event, ${id})">
                    <div class="form-group">
                        <label class="form-label">Warehouse</label>
                        <input type="text" class="form-control" value="${inv.warehouseName}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="editInvQuantity" value="${inv.quantity}" step="0.1" min="0" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeEditInventoryModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeEditInventoryModal() {
    const modal = document.getElementById('editInventoryModal');
    if (modal) modal.remove();
}

function updateInventory(e, id) {
    e.preventDefault();
    const inv = warehouseInventory.find(i => i.id === id);
    if (!inv) return;
    
    const newQty = parseFloat(document.getElementById('editInvQuantity').value);
    
    inv.quantity = newQty;
    inv.lastUpdated = new Date().toISOString().split('T')[0];
    
    // Update product total stock
    const product = products.find(p => p.id === inv.productId);
    const productInv = warehouseInventory.filter(i => i.productId === inv.productId);
    product.currentStock = productInv.reduce((sum, i) => sum + i.quantity, 0);
    
    closeEditInventoryModal();
    showAlert('success', 'Inventory updated successfully!');
    renderInventoryTable();
}

function renderInventoryGrid() {
    let html = '';
    products.forEach(product => {
        const stockStatus = product.currentStock <= product.restockLevel ? 'Low Stock' : 
                          product.currentStock === 0 ? 'Out of Stock' : 'In Stock';
        const badgeClass = stockStatus === 'In Stock' ? 'badge-success' : 
                          stockStatus === 'Low Stock' ? 'badge-warning' : 'badge-danger';

        html += `
            <div class="product-card">
                <div class="product-icon">üçÑ</div>
                <div class="product-name">${product.name}</div>
                <div class="product-category">${product.category}</div>
                <div class="product-stock">
                    <strong>Stock:</strong>
                    <span>${product.currentStock} ${product.unit}</span>
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-4);">
                    Restock at: ${product.restockLevel} ${product.unit}
                </div>
                <div class="mt-8">
                    <span class="badge ${badgeClass}">${stockStatus}</span>
                </div>
                <div class="mt-8" style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                    Restock at: ${product.restockLevel} ${product.unit}
                </div>
            </div>
        `;
    });

    document.getElementById('inventoryGrid').innerHTML = html;
}

function renderInventoryHistory() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Filter logs for current month
    const monthLogs = inventoryLog.filter(log => {
        const logDate = new Date(log.date);
        return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
    });
    
    // Calculate summary
    let totalAdded = 0, totalSold = 0, totalTransferred = 0, totalReturned = 0;
    monthLogs.forEach(log => {
        if (log.transactionType === 'Purchase' || log.transactionType === 'Stock Addition') {
            totalAdded += Math.abs(log.quantityChange);
        } else if (log.transactionType === 'Sale') {
            totalSold += Math.abs(log.quantityChange);
        } else if (log.transactionType === 'Transfer') {
            totalTransferred += Math.abs(log.quantityChange);
        } else if (log.transactionType === 'Return') {
            totalReturned += Math.abs(log.quantityChange);
        }
    });
    
    const currentStock = products.reduce((sum, p) => sum + p.currentStock, 0);
    const totalCapacity = warehouses.reduce((sum, w) => sum + (w.capacity || 500), 0);
    const utilization = totalCapacity > 0 ? ((currentStock / totalCapacity) * 100).toFixed(1) : 0;
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const monthName = monthNames[currentMonth];
    
    // Render summary box
    const summaryHTML = `
        <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-16); text-align: center;">Inventory Summary - ${monthName} ${currentYear}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-16);">
            <div style="text-align: center;">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Total Items Added</div>
                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);">${totalAdded.toFixed(0)}</div>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">this month</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Total Items Sold</div>
                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-error);">${totalSold.toFixed(0)}</div>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">this month</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Total Items Transferred</div>
                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-info);">${totalTransferred.toFixed(0)}</div>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">this month</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Total Items Returned</div>
                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-warning);">${totalReturned.toFixed(0)}</div>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">this month</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Current Stock</div>
                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">${currentStock.toFixed(0)}</div>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">units</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Warehouse Utilization %</div>
                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-info);">${utilization}%</div>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">capacity used</div>
            </div>
        </div>
    `;
    document.getElementById('inventoryHistorySummary').innerHTML = summaryHTML;
    
    // Sort logs by date descending (latest first)
    const logs = [...inventoryLog].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = '';
    logs.forEach(log => {
        const warehouse = warehouseInventory.find(inv => inv.productId === log.productId);
        const warehouseName = warehouse ? warehouse.warehouseName : 'N/A';
        
        html += `
            <tr>
                <td>${formatDate(log.date)}</td>
                <td>${warehouseName}</td>
                <td>${log.productName}</td>
                <td>${log.quantityChange > 0 ? '+' : ''}${log.quantityChange.toFixed(1)}</td>
                <td><span class="badge badge-info">${log.transactionType}</span></td>
            </tr>
        `;
    });

    document.getElementById('inventoryHistoryBody').innerHTML = html || '<tr><td colspan="5" class="text-center">No inventory history</td></tr>';
}

function decreaseInventoryQty() {
    const qtyInput = document.getElementById('inventoryQuantity');
    let currentQty = parseInt(qtyInput.value) || 1;
    if (currentQty > 1) {
        qtyInput.value = currentQty - 1;
    }
}

function increaseInventoryQty() {
    const qtyInput = document.getElementById('inventoryQuantity');
    let currentQty = parseInt(qtyInput.value) || 1;
    qtyInput.value = currentQty + 1;
}

function handleInventorySubmit(e) {
    e.preventDefault();

    const warehouseId = parseInt(document.getElementById('inventoryWarehouse').value);
    const warehouse = warehouses.find(w => w.id === warehouseId);
    const productId = parseInt(document.getElementById('inventoryProduct').value);
    const product = products.find(p => p.id === productId);
    const quantity = parseInt(document.getElementById('inventoryQuantity').value);
    const date = document.getElementById('inventoryDate').value;

    const log = {
        id: nextId.inventory++,
        date: date,
        productId: productId,
        productName: product.name,
        quantityChange: quantity,
        transactionType: 'Purchase',
        cost: 0,
        source: 'Stock Addition',
        notes: ''
    };

    inventoryLog.push(log);
    product.currentStock += quantity;
    
    // Update warehouse inventory
    let whInv = warehouseInventory.find(inv => inv.warehouseId === warehouseId && inv.productId === productId);
    if (whInv) {
        whInv.quantity += quantity;
        whInv.lastUpdated = date;
    } else {
        warehouseInventory.push({
            id: nextId.inventory++,
            warehouseId: warehouseId,
            warehouseName: warehouse.name,
            productId: productId,
            productName: product.name,
            quantity: quantity,
            lastUpdated: date
        });
    }

    showAlert('success', 'Stock added successfully!');
    document.getElementById('inventoryForm').reset();
    document.getElementById('inventoryDate').value = new Date().toISOString().split('T')[0];
    renderInventoryTable();
    renderInventoryHistory();
}

// Products Section
function renderProductsSection() {
    renderProductsGrid();
}

function renderProductsGrid() {
    let html = '';
    // Sort products by createdAt descending (latest first)
    const sortedProducts = [...products].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
    });
    
    sortedProducts.forEach(product => {
        html += `
            <div class="product-card">
                <div class="product-icon">üçÑ</div>
                <div class="product-name">${product.name}</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-8);">Unit: ${product.unit}</div>
                <div class="product-prices">
                    <div class="price-row">
                        <span>Retail:</span>
                        <strong>‚Çπ${product.retailPrice}</strong>
                    </div>
                    <div class="price-row">
                        <span>Wholesale:</span>
                        <strong>‚Çπ${product.wholesalePrice}</strong>
                    </div>
                </div>
                <div style="margin-top: var(--space-12); padding-top: var(--space-12); border-top: 1px solid var(--color-border);">
                    <div class="price-row">
                        <span>Stock:</span>
                        <strong>${product.currentStock} ${product.unit}</strong>
                    </div>
                </div>
                <div class="product-actions" style="margin-top: var(--space-16);">
                    <button class="btn btn-small btn-secondary" onclick="editProduct(${product.id})">Edit</button>
                    <button class="btn btn-small btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                </div>
            </div>
        `;
    });

    document.getElementById('productsGrid').innerHTML = html;
}

function handleProductSubmit(e) {
    e.preventDefault();

    const product = {
        id: nextId.product++,
        name: document.getElementById('productName').value,
        unit: document.getElementById('productUnit').value,
        retailPrice: parseFloat(document.getElementById('productRetailPrice').value),
        wholesalePrice: parseFloat(document.getElementById('productWholesalePrice').value),
        currentStock: 0,
        active: true,
        createdAt: new Date().toISOString()
    };

    products.push(product);
    
    // Create inventory entries for this product in all existing warehouses
    warehouses.forEach(warehouse => {
        warehouseInventory.push({
            id: nextId.inventory++,
            warehouseId: warehouse.id,
            warehouseName: warehouse.name,
            productId: product.id,
            productName: product.name,
            quantity: 0,
            lastUpdated: new Date().toISOString().split('T')[0]
        });
    });

    showAlert('success', 'Product added successfully!');
    document.getElementById('productsForm').reset();
    renderProductsGrid();
}

function deleteProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    const modalHTML = `
        <div class="modal active" id="deleteProductModal" style="align-items: center;">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Delete Product</h3>
                    <button class="modal-close" onclick="closeDeleteProductModal()">&times;</button>
                </div>
                <div style="padding: var(--space-16) 0;">
                    <p style="margin-bottom: var(--space-12);">Are you sure you want to delete <strong>${product.name}</strong>?</p>
                    <p style="color: var(--color-error); font-size: var(--font-size-sm);">‚ö†Ô∏è This product will be removed from all inventory.</p>
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteProductModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProduct(${id})">Delete</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeDeleteProductModal() {
    const modal = document.getElementById('deleteProductModal');
    if (modal) modal.remove();
}

function confirmDeleteProduct(id) {
    // Remove product
    products = products.filter(p => p.id !== id);
    
    // Remove from inventory
    warehouseInventory = warehouseInventory.filter(inv => inv.productId !== id);
    
    // Remove from sales
    sales = sales.filter(s => s.productId !== id);
    
    closeDeleteProductModal();
    showAlert('success', 'Product deleted successfully!');
    renderProductsGrid();
    renderDashboard();
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    // Populate form with product data
    document.getElementById('productName').value = product.name;
    document.getElementById('productUnit').value = product.unit;
    document.getElementById('productRetailPrice').value = product.retailPrice;
    document.getElementById('productWholesalePrice').value = product.wholesalePrice;
    
    // Change form button to update mode
    const form = document.getElementById('productsForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update Product';
    submitBtn.onclick = function(e) {
        e.preventDefault();
        updateProduct(id);
    };
    
    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth' });
    showAlert('info', 'Edit the product details and click Update Product');
}

function updateProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    product.name = document.getElementById('productName').value;
    product.unit = document.getElementById('productUnit').value;
    product.retailPrice = parseFloat(document.getElementById('productRetailPrice').value);
    product.wholesalePrice = parseFloat(document.getElementById('productWholesalePrice').value);
    
    showAlert('success', 'Product updated successfully!');
    resetProductForm();
    renderProductsGrid();
}

function resetProductForm() {
    const form = document.getElementById('productsForm');
    form.reset();
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Add Product';
    submitBtn.onclick = null;
}

// Wholesale Section
function renderWholesaleSection() {
    renderWholesaleCustomers();
    renderWholesaleTransactions();
}

function renderWholesaleCustomers() {
    // Sort customers by createdAt descending (latest first)
    const sortedCustomers = [...wholesaleCustomers].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
    });
    
    let html = '';
    sortedCustomers.forEach(customer => {
        html += `
            <tr>
                <td>${customer.name}</td>
                <td>${customer.businessName || '-'}</td>
                <td>${customer.phone}</td>
                <td>${customer.email || '-'}</td>
                <td>‚Çπ${customer.creditLimit.toFixed(2)}</td>
                <td>‚Çπ${customer.outstandingBalance.toFixed(2)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon" onclick="editWholesaleCustomer(${customer.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteWholesaleCustomer(${customer.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    });

    document.getElementById('wholesaleCustomersBody').innerHTML = html || '<tr><td colspan="7" class="text-center">No wholesale customers</td></tr>';
}

function renderWholesaleTransactions() {
    const wholesaleSales = sales.filter(s => s.saleType === 'Wholesale');
    
    let html = '';
    wholesaleSales.forEach(sale => {
        html += `
            <tr>
                <td>${formatDate(sale.date)}</td>
                <td>${sale.customerName}</td>
                <td>${sale.productName}</td>
                <td>${sale.quantity}</td>
                <td>‚Çπ${sale.totalAmount.toFixed(2)}</td>
                <td>${sale.paymentMethod}</td>
            </tr>
        `;
    });

    document.getElementById('wholesaleTransactionsBody').innerHTML = html || '<tr><td colspan="6" class="text-center">No wholesale transactions</td></tr>';
}

function handleWholesaleCustomerSubmit(e) {
    e.preventDefault();

    const customer = {
        id: nextId.customer++,
        name: document.getElementById('wholesaleCustomerName').value,
        businessName: document.getElementById('wholesaleBusinessName').value,
        phone: document.getElementById('wholesalePhone').value,
        email: document.getElementById('wholesaleEmail').value,
        address: document.getElementById('wholesaleAddress').value,
        creditLimit: parseFloat(document.getElementById('wholesaleCreditLimit').value) || 0,
        outstandingBalance: 0
    };

    wholesaleCustomers.push(customer);

    showAlert('success', 'Wholesale customer added successfully!');
    document.getElementById('wholesaleCustomerForm').reset();
    renderWholesaleCustomers();
}

function editWholesaleCustomer(id) {
    const customer = wholesaleCustomers.find(c => c.id === id);
    if (!customer) return;
    
    const modalHTML = `
        <div class="modal active" id="editCustomerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Wholesale Customer</h3>
                    <button class="modal-close" onclick="closeEditCustomerModal()">&times;</button>
                </div>
                <form id="editCustomerForm" onsubmit="updateWholesaleCustomer(event, ${id})">
                    <div class="form-group">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="editCustomerName" value="${customer.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Business Name</label>
                        <input type="text" class="form-control" id="editBusinessName" value="${customer.businessName || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="editPhone" value="${customer.phone}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (Optional)</label>
                        <input type="email" class="form-control" id="editEmail" value="${customer.email || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Credit Limit (‚Çπ)</label>
                        <input type="number" class="form-control" id="editCreditLimit" value="${customer.creditLimit}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="editAddress">${customer.address || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeEditCustomerModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Customer</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeEditCustomerModal() {
    const modal = document.getElementById('editCustomerModal');
    if (modal) modal.remove();
}

function updateWholesaleCustomer(e, id) {
    e.preventDefault();
    
    const customer = wholesaleCustomers.find(c => c.id === id);
    if (!customer) return;
    
    customer.name = document.getElementById('editCustomerName').value;
    customer.businessName = document.getElementById('editBusinessName').value;
    customer.phone = document.getElementById('editPhone').value;
    customer.email = document.getElementById('editEmail').value;
    customer.creditLimit = parseFloat(document.getElementById('editCreditLimit').value) || 0;
    customer.address = document.getElementById('editAddress').value;
    
    closeEditCustomerModal();
    showAlert('success', 'Customer updated successfully!');
    renderWholesaleCustomers();
}

function deleteWholesaleCustomer(id) {
    const customer = wholesaleCustomers.find(c => c.id === id);
    if (!customer) return;
    
    const modalHTML = `
        <div class="modal active" id="deleteCustomerModal" style="align-items: center;">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Delete Customer</h3>
                    <button class="modal-close" onclick="closeDeleteCustomerModal()">&times;</button>
                </div>
                <div style="padding: var(--space-16) 0;">
                    <p style="margin-bottom: var(--space-12);">Are you sure you want to delete <strong>${customer.name}</strong>?</p>
                    <p style="color: var(--color-error); font-size: var(--font-size-sm);">‚ö†Ô∏è This customer will be permanently removed.</p>
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteCustomerModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteCustomer(${id})">Delete</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeDeleteCustomerModal() {
    const modal = document.getElementById('deleteCustomerModal');
    if (modal) modal.remove();
}

function confirmDeleteCustomer(id) {
    wholesaleCustomers = wholesaleCustomers.filter(c => c.id !== id);
    closeDeleteCustomerModal();
    showAlert('success', 'Customer deleted successfully!');
    renderWholesaleCustomers();
}

// Analytics Section
function renderAnalytics() {
    const period = document.getElementById('analyticsPeriod').value;
    const filteredSales = filterSalesByPeriod(sales, period);
    const filteredReturns = filterSalesByPeriod(returns.map(r => ({date: r.returnDate})), period);

    // Calculate stats
    const retailSales = filteredSales.filter(s => s.saleType === 'Retail');
    const wholesaleSales = filteredSales.filter(s => s.saleType === 'Wholesale');
    const retailRevenue = retailSales.reduce((sum, s) => sum + s.totalAmount, 0);
    const wholesaleRevenue = wholesaleSales.reduce((sum, s) => sum + s.totalAmount, 0);
    const totalRevenue = retailRevenue + wholesaleRevenue;
    const totalUnits = filteredSales.reduce((sum, s) => sum + s.quantity, 0);
    const avgOrderValue = filteredSales.length > 0 ? totalRevenue / filteredSales.length : 0;

    // Revenue Summary - Single Line
    document.getElementById('revenueSummaryLine').innerHTML = `
        <strong>Retail Sales:</strong> ‚Çπ${retailRevenue.toLocaleString('en-IN', {maximumFractionDigits: 0})} | 
        <strong>Wholesale Sales:</strong> ‚Çπ${wholesaleRevenue.toLocaleString('en-IN', {maximumFractionDigits: 0})} | 
        <strong>Total:</strong> ‚Çπ${totalRevenue.toLocaleString('en-IN', {maximumFractionDigits: 0})}
    `;

    const statsHTML = `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total Revenue</span>
                <span class="stat-icon">üí∞</span>
            </div>
            <div class="stat-value">‚Çπ${totalRevenue.toFixed(2)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Units Sold</span>
                <span class="stat-icon">üì¶</span>
            </div>
            <div class="stat-value">${totalUnits.toFixed(1)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Avg Order Value</span>
                <span class="stat-icon">üìä</span>
            </div>
            <div class="stat-value">‚Çπ${avgOrderValue.toFixed(2)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Transactions</span>
                <span class="stat-icon">üìã</span>
            </div>
            <div class="stat-value">${filteredSales.length}</div>
        </div>
    `;

    document.getElementById('analyticsStats').innerHTML = statsHTML;

    // Sales by product chart
    const productSales = {};
    filteredSales.forEach(sale => {
        if (!productSales[sale.productName]) {
            productSales[sale.productName] = 0;
        }
        productSales[sale.productName] += sale.totalAmount;
    });

    const sortedProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const maxValue = Math.max(...sortedProducts.map(p => p[1]));

    let chartHTML = '';
    sortedProducts.forEach(([name, value]) => {
        const height = (value / maxValue) * 100;
        chartHTML += `
            <div class="bar-item">
                <div class="bar-value">‚Çπ${value.toFixed(0)}</div>
                <div class="bar" style="height: ${height}%"></div>
                <div class="bar-label">${name}</div>
            </div>
        `;
    });

    document.getElementById('salesByProductChart').innerHTML = chartHTML;

    // Top customers
    const customerSales = {};
    filteredSales.forEach(sale => {
        if (!customerSales[sale.customerName]) {
            customerSales[sale.customerName] = { total: 0, orders: 0 };
        }
        customerSales[sale.customerName].total += sale.totalAmount;
        customerSales[sale.customerName].orders++;
    });

    const topCustomers = Object.entries(customerSales)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);

    let customersHTML = '';
    topCustomers.forEach(([name, data]) => {
        customersHTML += `
            <tr>
                <td>${name}</td>
                <td>‚Çπ${data.total.toFixed(2)}</td>
                <td>${data.orders}</td>
            </tr>
        `;
    });

    document.getElementById('topCustomersBody').innerHTML = customersHTML || '<tr><td colspan="3" class="text-center">No data available</td></tr>';

    // Returns Analytics
    const periodReturns = returns.filter(ret => {
        const retDate = new Date(ret.returnDate);
        return filterSalesByPeriod([{date: ret.returnDate}], period).length > 0;
    });
    
    const totalReturnsCount = periodReturns.length;
    const totalReturnsAmount = periodReturns.reduce((sum, r) => sum + r.returnAmount, 0);
    const returnRate = filteredSales.length > 0 ? ((totalReturnsCount / filteredSales.length) * 100).toFixed(1) : 0;
    
    const returnsStatsHTML = `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total Returns</span>
                <span class="stat-icon">‚Ü©Ô∏è</span>
            </div>
            <div class="stat-value">${totalReturnsCount}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Return Amount</span>
                <span class="stat-icon">üí∞</span>
            </div>
            <div class="stat-value">‚Çπ${totalReturnsAmount.toFixed(2)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Return Rate</span>
                <span class="stat-icon">üìä</span>
            </div>
            <div class="stat-value">${returnRate}%</div>
        </div>
    `;
    document.getElementById('returnsAnalyticsStats').innerHTML = returnsStatsHTML;
    
    // Top returned products
    const returnsByProduct = {};
    periodReturns.forEach(ret => {
        if (!returnsByProduct[ret.productName]) {
            returnsByProduct[ret.productName] = { count: 0, quantity: 0, amount: 0 };
        }
        returnsByProduct[ret.productName].count++;
        returnsByProduct[ret.productName].quantity += ret.quantityReturned;
        returnsByProduct[ret.productName].amount += ret.returnAmount;
    });
    
    const topReturned = Object.entries(returnsByProduct)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5);
    
    let topReturnedHTML = '';
    topReturned.forEach(([name, data]) => {
        topReturnedHTML += `
            <tr>
                <td>${name}</td>
                <td>${data.count}</td>
                <td>${data.quantity.toFixed(1)}</td>
                <td>‚Çπ${data.amount.toFixed(2)}</td>
            </tr>
        `;
    });
    document.getElementById('topReturnedProductsBody').innerHTML = topReturnedHTML || '<tr><td colspan="4" class="text-center">No returns in this period</td></tr>';
}

function filterSalesByPeriod(salesData, period) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    return salesData.filter(sale => {
        const saleDate = new Date(sale.date);
        saleDate.setHours(0, 0, 0, 0);

        switch(period) {
            case 'today':
                return saleDate.getTime() === today.getTime();
            case 'week':
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                return saleDate >= weekAgo;
            case 'month':
                return saleDate.getMonth() === today.getMonth() && 
                       saleDate.getFullYear() === today.getFullYear();
            case 'year':
                return saleDate.getFullYear() === today.getFullYear();
            default:
                return true;
        }
    });
}

// Expenses Section
function renderExpensesSection() {
    renderExpensesStats();
    renderExpensesTable();
}

function renderExpensesStats() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    const monthExpenses = expenses.filter(e => {
        const expDate = new Date(e.date);
        return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
    });

    const totalExpenses = monthExpenses.reduce((sum, e) => sum + e.amount, 0);

    // Expenses by category
    const byCategory = {};
    monthExpenses.forEach(exp => {
        if (!byCategory[exp.category]) {
            byCategory[exp.category] = 0;
        }
        byCategory[exp.category] += exp.amount;
    });

    const topCategory = Object.entries(byCategory).sort((a, b) => b[1] - a[1])[0];

    const statsHTML = `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total Expenses</span>
                <span class="stat-icon">üí≥</span>
            </div>
            <div class="stat-value">‚Çπ${totalExpenses.toFixed(2)}</div>
            <div class="stat-change">This month</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Transactions</span>
                <span class="stat-icon">üìã</span>
            </div>
            <div class="stat-value">${monthExpenses.length}</div>
            <div class="stat-change">This month</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Top Category</span>
                <span class="stat-icon">üìä</span>
            </div>
            <div class="stat-value">${topCategory ? topCategory[0] : '-'}</div>
            <div class="stat-change">${topCategory ? '‚Çπ' + topCategory[1].toFixed(2) : '-'}</div>
        </div>
    `;

    document.getElementById('expensesStats').innerHTML = statsHTML;
}

function renderExpensesTable() {
    const categoryFilter = document.getElementById('expenseCategoryFilter').value;

    let filteredExpenses = expenses.filter(exp => {
        return !categoryFilter || exp.category === categoryFilter;
    });

    filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    filteredExpenses.forEach(exp => {
        html += `
            <tr>
                <td>${formatDate(exp.date)}</td>
                <td><span class="badge badge-info">${exp.category}</span></td>
                <td>${exp.description}</td>
                <td>‚Çπ${exp.amount.toFixed(2)}</td>
                <td>${exp.vendor || '-'}</td>
                <td>${exp.paymentMethod}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon" onclick="editExpense(${exp.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteExpense(${exp.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    });

    document.getElementById('expensesTableBody').innerHTML = html || '<tr><td colspan="7" class="text-center">No expenses found</td></tr>';
}

function handleExpenseSubmit(e) {
    e.preventDefault();

    const expense = {
        id: nextId.expense++,
        date: document.getElementById('expenseDate').value,
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        paymentMethod: document.getElementById('expensePaymentMethod').value,
        vendor: document.getElementById('expenseVendor').value,
        notes: ''
    };

    expenses.push(expense);

    // Add notification
    addNotification('expense', 'New Expense Added', 
        `${expense.category}: ‚Çπ${expense.amount.toFixed(2)} - ${expense.description}`,
        { expenseId: expense.id });

    showAlert('success', 'Expense added successfully!');
    document.getElementById('expensesForm').reset();
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    renderExpensesStats();
    renderExpensesTable();
}

function editExpense(id) {
    const expense = expenses.find(e => e.id === id);
    if (!expense) return;
    
    document.getElementById('expenseDate').value = expense.date;
    document.getElementById('expenseCategory').value = expense.category;
    document.getElementById('expenseAmount').value = expense.amount;
    document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
    document.getElementById('expenseVendor').value = expense.vendor || '';
    document.getElementById('expenseDescription').value = expense.description;
    
    const form = document.getElementById('expensesForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update Expense';
    submitBtn.onclick = function(e) {
        e.preventDefault();
        updateExpense(id);
    };
    
    form.scrollIntoView({ behavior: 'smooth' });
    showAlert('info', 'Edit expense details and click Update Expense');
}

function updateExpense(id) {
    const expense = expenses.find(e => e.id === id);
    if (!expense) return;
    
    expense.date = document.getElementById('expenseDate').value;
    expense.category = document.getElementById('expenseCategory').value;
    expense.description = document.getElementById('expenseDescription').value;
    expense.amount = parseFloat(document.getElementById('expenseAmount').value);
    expense.paymentMethod = document.getElementById('expensePaymentMethod').value;
    expense.vendor = document.getElementById('expenseVendor').value;
    
    showAlert('success', 'Expense updated successfully!');
    resetExpenseForm();
    renderExpensesStats();
    renderExpensesTable();
    renderDashboard();
}

function resetExpenseForm() {
    const form = document.getElementById('expensesForm');
    form.reset();
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Add Expense';
    submitBtn.onclick = null;
}

function deleteExpense(id) {
    if (confirm('Are you sure you want to delete this expense?')) {
        expenses = expenses.filter(e => e.id !== id);
        showAlert('success', 'Expense deleted successfully!');
        renderExpensesStats();
        renderExpensesTable();
        renderDashboard();
    }
}

// Profit & Loss Section
function renderProfitLoss() {
    const period = document.getElementById('plPeriod').value;
    const filteredSales = filterSalesByPeriod(sales, period);
    const filteredExpenses = filterExpensesByPeriod(expenses, period);

    // Revenue
    const retailSales = filteredSales.filter(s => s.saleType === 'Retail');
    const wholesaleSales = filteredSales.filter(s => s.saleType === 'Wholesale');
    
    const retailRevenue = retailSales.reduce((sum, s) => sum + s.totalAmount, 0);
    const wholesaleRevenue = wholesaleSales.reduce((sum, s) => sum + s.totalAmount, 0);
    const totalRevenue = retailRevenue + wholesaleRevenue;

    document.getElementById('plRevenue').innerHTML = `
        <div class="price-row">
            <span>Retail Sales:</span>
            <strong>‚Çπ${retailRevenue.toFixed(2)}</strong>
        </div>
        <div class="price-row">
            <span>Wholesale Sales:</span>
            <strong>‚Çπ${wholesaleRevenue.toFixed(2)}</strong>
        </div>
        <div class="price-row" style="border-top: 1px solid var(--color-border); padding-top: var(--space-8); margin-top: var(--space-8);">
            <strong>Total Revenue:</strong>
            <strong style="color: var(--color-success);">‚Çπ${totalRevenue.toFixed(2)}</strong>
        </div>
    `;

    // COGS
    const rawMaterialsExpenses = filteredExpenses
        .filter(e => e.category === 'Raw Materials')
        .reduce((sum, e) => sum + e.amount, 0);
    const laborExpenses = filteredExpenses
        .filter(e => e.category === 'Labor')
        .reduce((sum, e) => sum + e.amount, 0);
    const totalCOGS = rawMaterialsExpenses + laborExpenses;

    document.getElementById('plCOGS').innerHTML = `
        <div class="price-row">
            <span>Raw Materials:</span>
            <strong>‚Çπ${rawMaterialsExpenses.toFixed(2)}</strong>
        </div>
        <div class="price-row">
            <span>Direct Labor:</span>
            <strong>‚Çπ${laborExpenses.toFixed(2)}</strong>
        </div>
        <div class="price-row" style="border-top: 1px solid var(--color-border); padding-top: var(--space-8); margin-top: var(--space-8);">
            <strong>Total COGS:</strong>
            <strong style="color: var(--color-error);">‚Çπ${totalCOGS.toFixed(2)}</strong>
        </div>
        <div class="price-row" style="margin-top: var(--space-12);">
            <strong>Gross Profit:</strong>
            <strong style="color: var(--color-success);">‚Çπ${(totalRevenue - totalCOGS).toFixed(2)}</strong>
        </div>
    `;

    // Operating Expenses
    const expensesByCategory = {};
    filteredExpenses
        .filter(e => e.category !== 'Raw Materials' && e.category !== 'Labor')
        .forEach(exp => {
            if (!expensesByCategory[exp.category]) {
                expensesByCategory[exp.category] = 0;
            }
            expensesByCategory[exp.category] += exp.amount;
        });

    let expensesHTML = '';
    Object.entries(expensesByCategory).forEach(([category, amount]) => {
        expensesHTML += `
            <div class="price-row">
                <span>${category}:</span>
                <strong>‚Çπ${amount.toFixed(2)}</strong>
            </div>
        `;
    });

    const totalOpExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);

    document.getElementById('plExpenses').innerHTML = `
        ${expensesHTML}
        <div class="price-row" style="border-top: 1px solid var(--color-border); padding-top: var(--space-8); margin-top: var(--space-8);">
            <strong>Total Operating Expenses:</strong>
            <strong style="color: var(--color-error);">‚Çπ${totalOpExpenses.toFixed(2)}</strong>
        </div>
    `;

    // Returns & Adjustments
    const periodReturns = returns.filter(ret => {
        const retDate = new Date(ret.returnDate);
        return filterExpensesByPeriod([{date: ret.returnDate}], period).length > 0;
    });
    
    const totalReturnsAmount = periodReturns.reduce((sum, r) => sum + r.returnAmount, 0);
    
    document.getElementById('plReturns').innerHTML = `
        <div class="price-row">
            <span>Sales Returns:</span>
            <strong style="color: var(--color-error);">‚Çπ${filteredReturnsAmount.toFixed(2)}</strong>
        </div>
        <div class="price-row">
            <span>Number of Returns:</span>
            <strong>${filteredReturns.length}</strong>
        </div>
    `;

    // Net Profit
    const grossProfit = totalRevenue - totalCOGS;
    const filteredReturns = returns.filter(ret => {
        const retDate = new Date(ret.returnDate);
        return filterExpensesByPeriod([{date: ret.returnDate}], period).length > 0;
    });
    const filteredReturnsAmount = filteredReturns.reduce((sum, r) => sum + r.returnAmount, 0);
    const netProfit = grossProfit - totalOpExpenses - filteredReturnsAmount;
    const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;

    document.getElementById('plNetProfit').innerHTML = `
        <div class="price-row">
            <span>Gross Profit:</span>
            <strong>‚Çπ${grossProfit.toFixed(2)}</strong>
        </div>
        <div class="price-row">
            <span>Operating Expenses:</span>
            <strong>‚Çπ${totalOpExpenses.toFixed(2)}</strong>
        </div>
        <div class="price-row" style="border-top: 2px solid var(--color-border); padding-top: var(--space-12); margin-top: var(--space-12);">
            <strong style="font-size: var(--font-size-lg);">Net Profit:</strong>
            <strong style="font-size: var(--font-size-2xl); color: ${netProfit >= 0 ? 'var(--color-success)' : 'var(--color-error)'};">
                ‚Çπ${netProfit.toFixed(2)}
            </strong>
        </div>
        <div class="price-row" style="margin-top: var(--space-8);">
            <span>Profit Margin:</span>
            <strong style="color: ${profitMargin >= 0 ? 'var(--color-success)' : 'var(--color-error)'};">
                ${profitMargin.toFixed(2)}%
            </strong>
        </div>
    `;
}

function filterExpensesByPeriod(expensesData, period) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    return expensesData.filter(exp => {
        const expDate = new Date(exp.date);
        expDate.setHours(0, 0, 0, 0);

        switch(period) {
            case 'month':
                return expDate.getMonth() === today.getMonth() && 
                       expDate.getFullYear() === today.getFullYear();
            case 'quarter':
                const currentQuarter = Math.floor(today.getMonth() / 3);
                const expQuarter = Math.floor(expDate.getMonth() / 3);
                return expQuarter === currentQuarter && expDate.getFullYear() === today.getFullYear();
            case 'year':
                return expDate.getFullYear() === today.getFullYear();
            default:
                return true;
        }
    });
}

function exportPL() {
    showAlert('success', 'P&L Report export functionality would generate a downloadable report');
}

// Returns Section
function renderReturnsSection() {
    populateProductDropdown('returnProduct');
    renderEligibleSales();
    renderReturnsStats();
    renderReturnsTable();
}

function renderEligibleSales() {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
    const threeDaysAgo = new Date(now.getTime() - (3 * 24 * 60 * 60 * 1000));
    
    const eligibleSales = sales.filter(sale => {
        const saleDate = new Date(sale.date);
        if (sale.saleType === 'Retail') {
            return saleDate >= oneDayAgo;
        } else if (sale.saleType === 'Wholesale') {
            return saleDate >= threeDaysAgo;
        }
        return false;
    });
    
    // Sort by date descending (latest first)
    eligibleSales.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = '';
    eligibleSales.forEach(sale => {
        const qtyReturned = sale.quantityReturned || 0;
        const available = sale.quantity - qtyReturned;
        const fullyReturned = available <= 0;
        
        let statusBadge = '';
        if (fullyReturned) {
            statusBadge = '<span class="badge badge-success">Fully Returned</span>';
        } else if (qtyReturned > 0) {
            statusBadge = '<span class="badge badge-warning">Partially Returned</span>';
        } else {
            statusBadge = '<span class="badge badge-info">Available</span>';
        }
        
        html += `
            <tr>
                <td>${formatDate(sale.date)}</td>
                <td>${sale.customerName}</td>
                <td>${sale.productName}</td>
                <td>${sale.quantity}</td>
                <td>${qtyReturned}</td>
                <td><strong>${available}</strong></td>
                <td>${statusBadge}</td>
                <td>
                    ${fullyReturned ? 
                        '<button class="btn btn-small btn-secondary" disabled title="All items returned">Return</button>' :
                        `<button class="btn btn-small btn-primary" onclick="processReturnFromSale(${sale.id})">Return</button>`
                    }
                </td>
            </tr>
        `;
    });
    
    document.getElementById('eligibleSalesBody').innerHTML = html || '<tr><td colspan="8" class="text-center">No eligible sales for return</td></tr>';
}

function processReturnFromSale(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;
    
    const available = sale.quantity - (sale.quantityReturned || 0);
    
    // Pre-fill return form
    document.getElementById('returnDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('returnSaleId').value = sale.id;
    document.getElementById('returnCustomerName').value = sale.customerName;
    document.getElementById('returnProduct').value = sale.productId;
    document.getElementById('returnQuantity').value = Math.min(1, available);
    document.getElementById('returnMaxQuantity').value = available;
    document.getElementById('returnAmount').value = (sale.unitPrice * Math.min(1, available)).toFixed(2);
    
    // Scroll to form
    document.getElementById('returnsForm').scrollIntoView({ behavior: 'smooth' });
    showAlert('info', `Return form pre-filled. Available to return: ${available} units`);
}

function updateReturnMaxQuantity() {
    const saleId = document.getElementById('returnSaleId').value;
    if (saleId) {
        const sale = sales.find(s => s.id === parseInt(saleId));
        if (sale) {
            const available = Math.floor(sale.quantity - (sale.quantityReturned || 0));
            document.getElementById('returnMaxQuantity').value = available;
            document.getElementById('returnQuantity').value = Math.min(1, available);
        }
    }
}

function decreaseReturnQty() {
    const qtyInput = document.getElementById('returnQuantity');
    let currentQty = Math.floor(parseInt(qtyInput.value) || 1);
    if (currentQty > 1) {
        qtyInput.value = currentQty - 1;
        updateReturnAmount();
    }
}

function increaseReturnQty() {
    const qtyInput = document.getElementById('returnQuantity');
    const maxQty = Math.floor(parseInt(document.getElementById('returnMaxQuantity').value) || 1);
    let currentQty = Math.floor(parseInt(qtyInput.value) || 1);
    if (currentQty < maxQty) {
        qtyInput.value = currentQty + 1;
        updateReturnAmount();
    }
}

function updateReturnAmount() {
    const saleId = document.getElementById('returnSaleId').value;
    const qty = parseInt(document.getElementById('returnQuantity').value) || 1;
    if (saleId) {
        const sale = sales.find(s => s.id === parseInt(saleId));
        if (sale) {
            document.getElementById('returnAmount').value = (sale.unitPrice * qty).toFixed(2);
        }
    }
}

function renderReturnsStats() {
    const totalReturns = returns.length;
    const totalReturnAmount = returns.reduce((sum, r) => sum + r.returnAmount, 0);
    const totalSalesCount = sales.length;
    const returnRate = totalSalesCount > 0 ? (totalReturns / totalSalesCount) * 100 : 0;

    const statsHTML = `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total Returns</span>
                <span class="stat-icon">‚Ü©Ô∏è</span>
            </div>
            <div class="stat-value">${totalReturns}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Return Amount</span>
                <span class="stat-icon">üí∞</span>
            </div>
            <div class="stat-value">‚Çπ${totalReturnAmount.toFixed(2)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Return Rate</span>
                <span class="stat-icon">üìä</span>
            </div>
            <div class="stat-value">${returnRate.toFixed(2)}%</div>
        </div>
    `;

    document.getElementById('returnsStats').innerHTML = statsHTML;
}

function renderReturnsTable() {
    const sortedReturns = [...returns].sort((a, b) => new Date(b.returnDate) - new Date(a.returnDate));

    let html = '';
    sortedReturns.forEach(ret => {
        html += `
            <tr>
                <td>${formatDate(ret.returnDate)}</td>
                <td>${ret.customerName}</td>
                <td>${ret.productName}</td>
                <td>${ret.quantityReturned}</td>
                <td>‚Çπ${ret.returnAmount.toFixed(2)}</td>
                <td><span class="badge badge-warning">${ret.reason}</span></td>
                <td>${ret.refundMethod}</td>
                <td>
                    <button class="btn-icon" onclick="deleteReturn(${ret.id})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    });

    document.getElementById('returnsTableBody').innerHTML = html || '<tr><td colspan="8" class="text-center">No returns recorded</td></tr>';
}

function handleReturnSubmit(e) {
    e.preventDefault();

    const productId = parseInt(document.getElementById('returnProduct').value);
    const product = products.find(p => p.id === productId);
    const quantity = parseInt(document.getElementById('returnQuantity').value);
    const saleId = document.getElementById('returnSaleId').value;

    const returnData = {
        id: nextId.return++,
        returnDate: document.getElementById('returnDate').value,
        originalSaleId: saleId || null,
        customerName: document.getElementById('returnCustomerName').value,
        productId: productId,
        productName: product.name,
        quantityReturned: quantity,
        returnAmount: parseFloat(document.getElementById('returnAmount').value),
        reason: document.getElementById('returnReason').value,
        refundMethod: document.getElementById('returnRefundMethod').value,
        notes: document.getElementById('returnNotes').value
    };

    returns.push(returnData);

    // Add notification
    addNotification('return', 'Return Processed', 
        `${returnData.customerName} - ${returnData.productName}, Qty: ${returnData.quantityReturned} returned, Amount: ‚Çπ${returnData.returnAmount.toFixed(2)}`,
        { returnId: returnData.id });

    // Update sale's returned quantity
    if (saleId) {
        const sale = sales.find(s => s.id === parseInt(saleId));
        if (sale) {
            sale.quantityReturned = (sale.quantityReturned || 0) + quantity;
        }
    }

    // Restore inventory
    product.currentStock += quantity;
    
    // Update warehouse inventory (first warehouse with this product)
    const productInv = warehouseInventory.find(inv => inv.productId === productId);
    if (productInv) {
        productInv.quantity += quantity;
        productInv.lastUpdated = returnData.returnDate;
    }

    // Log inventory change
    inventoryLog.push({
        id: nextId.inventory++,
        date: returnData.returnDate,
        productId: product.id,
        productName: product.name,
        quantityChange: quantity,
        transactionType: 'Return',
        cost: 0,
        source: returnData.customerName,
        notes: `Return #${returnData.id} - ${returnData.reason}`
    });

    showAlert('success', 'Return processed successfully!');
    document.getElementById('returnsForm').reset();
    document.getElementById('returnDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('returnQuantity').value = 1;
    renderEligibleSales();
    renderReturnsStats();
    renderReturnsTable();
    renderDashboard();
}

function deleteReturn(id) {
    if (confirm('Are you sure you want to delete this return? Inventory will be adjusted.')) {
        const returnItem = returns.find(r => r.id === id);
        if (returnItem) {
            // Remove from inventory (reverse the return)
            const product = products.find(p => p.id === returnItem.productId);
            if (product) {
                product.currentStock -= returnItem.quantityReturned;
                
                // Update warehouse inventory
                const productInv = warehouseInventory.filter(inv => inv.productId === product.id);
                if (productInv.length > 0) {
                    productInv[0].quantity -= returnItem.quantityReturned;
                    productInv[0].lastUpdated = new Date().toISOString().split('T')[0];
                }
            }
        }
        
        returns = returns.filter(r => r.id !== id);
        showAlert('success', 'Return deleted and inventory adjusted!');
        renderReturnsStats();
        renderReturnsTable();
        renderDashboard();
    }
}

// Number Animation Helper
function animateNumber(value) {
    return value.toLocaleString('en-IN', {maximumFractionDigits: 2});
}

// Time Ago Helper
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    
    if (diffDays === 0) {
        if (diffHours === 0) {
            return 'Just now';
        } else if (diffHours === 1) {
            return '1 hour ago';
        } else {
            return `${diffHours} hours ago`;
        }
    } else if (diffDays === 1) {
        return '1 day ago';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else {
        return formatDate(dateString);
    }
}

// Utility Functions
function populateProductDropdown(elementId) {
    const select = document.getElementById(elementId);
    select.innerHTML = '<option value="">Select Product</option>';
    
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} (${product.currentStock} ${product.unit} available)`;
        select.appendChild(option);
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-IN', options);
}

function showAlert(type, message) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.style.position = 'fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '1000';
    alert.style.minWidth = '300px';
    alert.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
    `;

    document.body.appendChild(alert);

    // Remove after 3 seconds
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

// Modal Functions
function showAddSaleModal() {
    const modalHTML = `
        <div class="modal active" id="addSaleModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Sale</h3>
                    <button class="modal-close" onclick="closeAddSaleModal()">&times;</button>
                </div>
                <form id="modalRetailSalesForm" onsubmit="submitModalRetailSale(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control" id="modalRetailSaleDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="modalRetailCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Phone</label>
                            <input type="tel" class="form-control" id="modalRetailCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product *</label>
                            <select class="form-control" id="modalRetailProduct" required onchange="updateModalRetailPrice()">
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="modalRetailQuantity" value="1" min="1" step="1" required oninput="calculateModalRetailTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Price (‚Çπ) *</label>
                            <input type="number" class="form-control" id="modalRetailUnitPrice" step="0.01" required oninput="calculateModalRetailTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Amount (‚Çπ)</label>
                            <input type="number" class="form-control" id="modalRetailTotalAmount" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method *</label>
                            <select class="form-control" id="modalRetailPaymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Credit">Credit</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="modalRetailNotes" rows="2"></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddSaleModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Sale</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('modalRetailSaleDate').value = new Date().toISOString().split('T')[0];
    populateProductDropdown('modalRetailProduct');
}

function closeAddSaleModal() {
    const modal = document.getElementById('addSaleModal');
    if (modal) modal.remove();
}

function updateModalRetailPrice() {
    const productId = parseInt(document.getElementById('modalRetailProduct').value);
    if (productId) {
        const product = products.find(p => p.id === productId);
        if (product) {
            document.getElementById('modalRetailUnitPrice').value = product.retailPrice;
            calculateModalRetailTotal();
        }
    }
}

function calculateModalRetailTotal() {
    const quantity = parseFloat(document.getElementById('modalRetailQuantity').value) || 0;
    const unitPrice = parseFloat(document.getElementById('modalRetailUnitPrice').value) || 0;
    document.getElementById('modalRetailTotalAmount').value = (quantity * unitPrice).toFixed(2);
}

function submitModalRetailSale(e) {
    e.preventDefault();
    const productId = parseInt(document.getElementById('modalRetailProduct').value);
    const product = products.find(p => p.id === productId);
    const quantity = parseInt(document.getElementById('modalRetailQuantity').value);

    if (product.currentStock < quantity) {
        showAlert('error', 'Insufficient stock available!');
        return;
    }

    const sale = {
        id: nextId.sale++,
        date: document.getElementById('modalRetailSaleDate').value,
        customerName: document.getElementById('modalRetailCustomerName').value,
        customerPhone: document.getElementById('modalRetailCustomerPhone').value,
        productId: productId,
        productName: product.name,
        quantity: quantity,
        unitPrice: parseFloat(document.getElementById('modalRetailUnitPrice').value),
        totalAmount: parseFloat(document.getElementById('modalRetailTotalAmount').value),
        paymentMethod: document.getElementById('modalRetailPaymentMethod').value,
        saleType: 'Retail',
        notes: document.getElementById('modalRetailNotes').value,
        returned: false,
        quantityReturned: 0
    };

    sales.push(sale);
    product.currentStock -= quantity;
    
    const productInv = warehouseInventory.find(inv => inv.productId === product.id && inv.quantity >= quantity);
    if (productInv) {
        productInv.quantity -= quantity;
        productInv.lastUpdated = sale.date;
    }

    inventoryLog.push({
        id: nextId.inventory++,
        date: sale.date,
        productId: product.id,
        productName: product.name,
        quantityChange: -quantity,
        transactionType: 'Sale',
        cost: 0,
        source: sale.customerName,
        notes: `Sale #${sale.id}`
    });

    // Add notification - UPDATED to match expense notification style
    addNotification('sale', 'Sale Recorded', 
        `Customer: ${sale.customerName}, Product: ${sale.productName} x ${sale.quantity}, ‚Çπ${sale.totalAmount.toFixed(2)}`,
        { saleId: sale.id, customer: sale.customerName, product: sale.productName, quantity: sale.quantity, amount: sale.totalAmount });

    showAlert('success', 'Sale added successfully!');
    closeAddSaleModal();
    renderDashboard();
    if (document.getElementById('sales').classList.contains('active')) {
        renderSalesTable();
    }
}

function showAddProductModal() {
    const modalHTML = `
        <div class="modal active" id="addProductModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Product</h3>
                    <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
                </div>
                <form id="modalProductsForm" onsubmit="submitModalProduct(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="modalProductName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit *</label>
                            <select class="form-control" id="modalProductUnit" required>
                                <option value="kg">kg</option>
                                <option value="box" selected>box</option>
                                <option value="piece">piece</option>
                                <option value="crate">crate</option>
                                <option value="bundle">bundle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Retail Price (‚Çπ) *</label>
                            <input type="number" class="form-control" id="modalProductRetailPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Wholesale Price (‚Çπ) *</label>
                            <input type="number" class="form-control" id="modalProductWholesalePrice" step="0.01" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeAddProductModal() {
    const modal = document.getElementById('addProductModal');
    if (modal) modal.remove();
}

function submitModalProduct(e) {
    e.preventDefault();

    const product = {
        id: nextId.product++,
        name: document.getElementById('modalProductName').value,
        unit: document.getElementById('modalProductUnit').value,
        retailPrice: parseFloat(document.getElementById('modalProductRetailPrice').value),
        wholesalePrice: parseFloat(document.getElementById('modalProductWholesalePrice').value),
        currentStock: 0,
        active: true,
        createdAt: new Date().toISOString()
    };

    products.push(product);
    
    // Create inventory entries for this product in all existing warehouses
    warehouses.forEach(warehouse => {
        warehouseInventory.push({
            id: nextId.inventory++,
            warehouseId: warehouse.id,
            warehouseName: warehouse.name,
            productId: product.id,
            productName: product.name,
            quantity: 0,
            lastUpdated: new Date().toISOString().split('T')[0]
        });
    });
    
    showAlert('success', 'Product added successfully!');
    closeAddProductModal();
    if (document.getElementById('products').classList.contains('active')) {
        renderProductsGrid();
    }
}

function showAddExpenseModal() {
    const modalHTML = `
        <div class="modal active" id="addExpenseModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Expense</h3>
                    <button class="modal-close" onclick="closeAddExpenseModal()">&times;</button>
                </div>
                <form id="modalExpensesForm" onsubmit="submitModalExpense(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control" id="modalExpenseDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select class="form-control" id="modalExpenseCategory" required>
                                <option value="Raw Materials">Raw Materials</option>
                                <option value="Labor">Labor</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Packaging">Packaging</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount (‚Çπ) *</label>
                            <input type="number" class="form-control" id="modalExpenseAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method *</label>
                            <select class="form-control" id="modalExpensePaymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendor/Supplier</label>
                            <input type="text" class="form-control" id="modalExpenseVendor">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="modalExpenseDescription" required rows="2"></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddExpenseModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Expense</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('modalExpenseDate').value = new Date().toISOString().split('T')[0];
}

function closeAddExpenseModal() {
    const modal = document.getElementById('addExpenseModal');
    if (modal) modal.remove();
}

function submitModalExpense(e) {
    e.preventDefault();

    const expense = {
        id: nextId.expense++,
        date: document.getElementById('modalExpenseDate').value,
        category: document.getElementById('modalExpenseCategory').value,
        description: document.getElementById('modalExpenseDescription').value,
        amount: parseFloat(document.getElementById('modalExpenseAmount').value),
        paymentMethod: document.getElementById('modalExpensePaymentMethod').value,
        vendor: document.getElementById('modalExpenseVendor').value,
        notes: '',
        createdAt: new Date().toISOString()
    };

    expenses.push(expense);
    
    // Add notification
    addNotification('expense', 'New Expense Added', 
        `${expense.category}: ‚Çπ${expense.amount.toFixed(2)} - ${expense.description}`,
        { expenseId: expense.id });
    
    showAlert('success', 'Expense added successfully!');
    closeAddExpenseModal();
    renderDashboard();
    if (document.getElementById('expenses').classList.contains('active')) {
        renderExpensesStats();
        renderExpensesTable();
    }
}

function showAddStockModal() {
    const modalHTML = `
        <div class="modal active" id="addStockModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add Stock</h3>
                    <button class="modal-close" onclick="closeAddStockModal()">&times;</button>
                </div>
                <form id="modalInventoryForm" onsubmit="submitModalInventory(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Warehouse *</label>
                            <select class="form-control" id="modalInventoryWarehouse" required>
                                <option value="">Select Warehouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product *</label>
                            <select class="form-control" id="modalInventoryProduct" required>
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="modalInventoryQuantity" value="1" min="1" step="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Received *</label>
                            <input type="date" class="form-control" id="modalInventoryDate" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddStockModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Stock</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('modalInventoryDate').value = new Date().toISOString().split('T')[0];
    populateWarehouseDropdown('modalInventoryWarehouse');
    populateProductDropdown('modalInventoryProduct');
}

function closeAddStockModal() {
    const modal = document.getElementById('addStockModal');
    if (modal) modal.remove();
}

function submitModalInventory(e) {
    e.preventDefault();

    const warehouseId = parseInt(document.getElementById('modalInventoryWarehouse').value);
    const warehouse = warehouses.find(w => w.id === warehouseId);
    const productId = parseInt(document.getElementById('modalInventoryProduct').value);
    const product = products.find(p => p.id === productId);
    const quantity = parseInt(document.getElementById('modalInventoryQuantity').value);
    const date = document.getElementById('modalInventoryDate').value;
    
    if (!warehouse) {
        showAlert('error', 'Please select a warehouse!');
        return;
    }
    
    if (!product) {
        showAlert('error', 'Please select a product!');
        return;
    }

    const log = {
        id: nextId.inventory++,
        date: date,
        productId: productId,
        productName: product.name,
        quantityChange: quantity,
        transactionType: 'Stock Addition',
        cost: 0,
        source: `Added to ${warehouse.name}`,
        notes: ''
    };

    inventoryLog.push(log);
    product.currentStock += quantity;
    
    let whInv = warehouseInventory.find(inv => inv.warehouseId === warehouseId && inv.productId === productId);
    if (whInv) {
        whInv.quantity += quantity;
        whInv.lastUpdated = date;
    } else {
        warehouseInventory.push({
            id: nextId.inventory++,
            warehouseId: warehouseId,
            warehouseName: warehouse.name,
            productId: productId,
            productName: product.name,
            quantity: quantity,
            lastUpdated: date
        });
    }

    showAlert('success', `${quantity} units of ${product.name} added to ${warehouse.name}!`);
    closeAddStockModal();
    if (document.getElementById('inventory').classList.contains('active')) {
        renderInventoryTable();
        renderInventoryHistory();
    }
    renderDashboard();
}

function showAddWholesaleCustomerModal() {
    const modalHTML = `
        <div class="modal active" id="addWholesaleCustomerModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Add Wholesale Customer</h3>
                    <button class="modal-close" onclick="closeAddWholesaleCustomerModal()">&times;</button>
                </div>
                <form id="modalWholesaleCustomerForm" onsubmit="submitModalWholesaleCustomer(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="modalWholesaleCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Business Name</label>
                            <input type="text" class="form-control" id="modalWholesaleBusinessName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number *</label>
                            <input type="tel" class="form-control" id="modalWholesalePhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="modalWholesaleEmail">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Credit Limit (‚Çπ)</label>
                            <input type="number" class="form-control" id="modalWholesaleCreditLimit" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="modalWholesaleAddress" rows="2"></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddWholesaleCustomerModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Customer</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeAddWholesaleCustomerModal() {
    const modal = document.getElementById('addWholesaleCustomerModal');
    if (modal) modal.remove();
}

function submitModalWholesaleCustomer(e) {
    e.preventDefault();

    const customer = {
        id: nextId.customer++,
        name: document.getElementById('modalWholesaleCustomerName').value,
        businessName: document.getElementById('modalWholesaleBusinessName').value,
        phone: document.getElementById('modalWholesalePhone').value,
        email: document.getElementById('modalWholesaleEmail').value,
        address: document.getElementById('modalWholesaleAddress').value,
        creditLimit: parseFloat(document.getElementById('modalWholesaleCreditLimit').value) || 0,
        outstandingBalance: 0,
        createdAt: new Date().toISOString()
    };

    wholesaleCustomers.push(customer);
    showAlert('success', 'Wholesale customer added successfully!');
    closeAddWholesaleCustomerModal();
    if (document.getElementById('wholesale').classList.contains('active')) {
        renderWholesaleCustomers();
    }
}

function showAddSubscriptionModal() {
    const modalHTML = `
        <div class="modal active" id="addSubscriptionModal">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Subscriber</h3>
                    <button class="modal-close" onclick="closeAddSubscriptionModal()">&times;</button>
                </div>
                <form id="modalSubscriptionForm" onsubmit="submitModalSubscription(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="modalSubCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="modalSubPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="modalSubEmail">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product *</label>
                            <select class="form-control" id="modalSubProduct" required>
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity per Delivery *</label>
                            <input type="number" class="form-control" id="modalSubQuantity" value="1" min="1" step="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Frequency *</label>
                            <select class="form-control" id="modalSubFrequency" required>
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-weekly">Bi-weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date *</label>
                            <input type="date" class="form-control" id="modalSubStartDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method *</label>
                            <select class="form-control" id="modalSubPaymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Delivery Days (Select Multiple) *</label>
                        <div style="display: flex; gap: var(--space-12); flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Monday"> Monday
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Tuesday"> Tuesday
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Wednesday"> Wednesday
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Thursday"> Thursday
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Friday"> Friday
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Saturday"> Saturday
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-6);">
                                <input type="checkbox" name="modalDeliveryDay" value="Sunday"> Sunday
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Delivery Address *</label>
                        <textarea class="form-control" id="modalSubAddress" required rows="2"></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddSubscriptionModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Subscription</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('modalSubStartDate').value = new Date().toISOString().split('T')[0];
    populateProductDropdown('modalSubProduct');
}

function closeAddSubscriptionModal() {
    const modal = document.getElementById('addSubscriptionModal');
    if (modal) modal.remove();
}

function submitModalSubscription(e) {
    e.preventDefault();
    
    const deliveryDayCheckboxes = document.querySelectorAll('input[name="modalDeliveryDay"]:checked');
    const deliveryDays = Array.from(deliveryDayCheckboxes).map(cb => cb.value);
    
    if (deliveryDays.length === 0) {
        showAlert('error', 'Please select at least one delivery day!');
        return;
    }
    
    const productId = parseInt(document.getElementById('modalSubProduct').value);
    const product = products.find(p => p.id === productId);
    
    const subscription = {
        id: nextId.subscription++,
        customerName: document.getElementById('modalSubCustomerName').value,
        phone: document.getElementById('modalSubPhone').value,
        email: document.getElementById('modalSubEmail').value,
        productId: productId,
        productName: product.name,
        quantity: parseInt(document.getElementById('modalSubQuantity').value),
        frequency: document.getElementById('modalSubFrequency').value,
        deliveryDays: deliveryDays,
        address: document.getElementById('modalSubAddress').value,
        paymentMethod: document.getElementById('modalSubPaymentMethod').value,
        startDate: document.getElementById('modalSubStartDate').value,
        status: 'Active',
        createdAt: new Date().toISOString()
    };
    
    subscriptions.push(subscription);
    generateStockPrepFromSubscriptions();
    
    // Add notification
    addNotification('subscription', 'New Subscription Created', 
        `${subscription.customerName} - ${subscription.productName}, Qty: ${subscription.quantity}, ${subscription.frequency}`,
        { subscriptionId: subscription.id });
    
    showAlert('success', 'Subscription added successfully!');
    closeAddSubscriptionModal();
    if (document.getElementById('subscriptions').classList.contains('active')) {
        renderSubscriptionsTable();
    }
    if (document.getElementById('stockprep').classList.contains('active')) {
        renderStockPrepSection();
    }
}

// Initialize app when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    // DOM is already loaded
    initializeApp();
}
    </script>
</body>
</html>